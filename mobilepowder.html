<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß™ Powder Inventory data check</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
:root {
  --pkg-a: 65px;
  --pkg-b: 65px;
  --pkg-c: 65px;
}

body {
  font-family: 'Inter', sans-serif;
  background: #f1f5f9;
  color: #1e293b;
  padding: 20px;
  min-height: 100vh;
  margin: 0;
}

.container {
  max-width: 480px;
  margin: 0 auto;
  background: white;
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.header-bar {
  background: linear-gradient(90deg, #0f7250, #0c5f43);
  color: white;
  text-align: center;
  padding: 12px;
  border-radius: 14px 14px 0 0;
  margin: -24px -24px 20px -24px;
}

.header-bar h3 {
  margin: 0;
  font-weight: 600;
  font-size: 17px;
}

label {
  font-weight: 600;
  font-size: 13.5px;
}

input, select {
  width: 100%;
  border: 1.5px solid #cbd5e1;
  border-radius: 6px;
  font-size: 14px;
  height: 42px;
  padding: 0 10px;
  box-sizing: border-box;
  transition: background-color 0.2s ease, color 0.2s ease;
}

input[readonly], select:disabled {
  background-color: #f1f5f9 !important;
  color: #6b7280;
  cursor: not-allowed;
}

input.editable, select.editable {
  background-color: #ffffff !important;
  color: #1e293b;
  cursor: text;
}

button {
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-weight: 600;
  cursor: pointer;
}

.btn-primary {
  background: #0f7250;
  color: white;
  font-size: 14px;
}

.btn-add {
  background: #129266;
  color: white;
  font-size: 20px;
}

.name-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
  flex-wrap: wrap;
}

.worker-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.worker-card {
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  background: #ffffff;
  color: #0f172a;
  text-align: center;
  padding: 12px;
  font-weight: 700;
  cursor: pointer;
}

.worker-card.active {
  border-color: #0f7250;
  background: #ecfdf5;
  color: #065f46;
  box-shadow: 0 0 0 2px rgba(15, 114, 80, 0.2);
}

.name-row select {
  flex: 1;
  height: 42px;
}

.name-row button {
  flex: 0 0 110px;
  height: 42px;
}

.row2col {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.col {
  flex: 1;
  min-width: 120px;
}

.rack-set {
  border: 1.5px solid #d1d5db;
  border-radius: 12px;
  padding: 14px;
  margin-top: 10px;
  margin-bottom: 15px;
  background: linear-gradient(180deg, #ecfdf5 0%, #d1fae5 100%);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.rack-set:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(12, 95, 67, 0.2);
}

.set-title {
  font-size: 14px;
  font-weight: 700;
  color: #065f46;
  margin-bottom: 8px;
}

.action-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  margin-top: -4px;
}

.btn-edit,
.btn-delete {
  border-radius: 6px;
  padding: 6px 10px;
  font-weight: bold;
  color: white;
  cursor: pointer;
  border: none;
}

.btn-edit {
  background: #0f7250;
}

.btn-delete {
  background: #ef4444;
}

.package-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  gap: 10px;
  flex-wrap: nowrap;
  margin-top: 10px;
}

.package-box {
  flex: 0 0 70%;
  display: flex;
  flex-direction: column;
}

.actQty-box {
  flex: 0 0 20%;
  display: flex;
  flex-direction: column;
}

.package-inputs {
  display: flex;
  align-items: center;
  gap: 6px;
}

.pkg-input {
  text-align: center;
  border: 1.5px solid #cbd5e1;
  border-radius: 6px;
  height: 42px;
  font-size: 14px;
}

.pkg-input.a { width: var(--pkg-a); }
.pkg-input.b { width: var(--pkg-b); }
.pkg-input.c { width: var(--pkg-c); }

.package-inputs span {
  font-weight: 600;
}

.footer {
  text-align: center;
  margin-top: 20px;
  font-size: 12px;
  color: #94a3b8;
}

.area-set-card {
  border: 1px solid #d1d5db;
  border-radius: 10px;
  background: #ffffff;
  padding: 10px;
  margin-top: 8px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  overflow: hidden;
}

.area-set-content {
  flex: 1;
  min-width: 0;
}

.area-set-row {
  display: grid;
  grid-template-columns: 112px 1fr;
  gap: 8px;
  font-size: 12px;
  margin-bottom: 3px;
}

.area-set-key {
  color: #475569;
  font-weight: 600;
}

.area-set-val {
  color: #0f172a;
  word-break: break-word;
}

.old-val {
  color: #dc2626;
  text-decoration: line-through;
  font-weight: 600;
}

.new-val {
  color: #0f172a;
  font-weight: 600;
}

.area-set-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex: 0 0 72px;
  align-items: stretch;
  align-self: stretch;
}

.btn-yes,
.btn-no {
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  width: 100%;
  min-height: 42px;
  padding: 8px 10px;
  box-sizing: border-box;
}

.btn-yes { background: #0f7250; }
.btn-no { background: #b91c1c; }
.btn-yes.active { background: #065f46; box-shadow: 0 0 0 2px rgba(15,114,80,.2); }
.btn-no.active { background: #991b1b; box-shadow: 0 0 0 2px rgba(185,28,28,.2); }

.decision-yes {
  width: 100%;
  color: #0f7250;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  font-weight: 800;
  line-height: 1;
}

.decision-no {
  width: 100%;
  color: #b91c1c;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: 800;
  line-height: 1;
}

.confirm-bar {
  display: none;
  margin-top: 12px;
}

.btn-confirm {
  width: 100%;
  border: none;
  border-radius: 10px;
  background: #0f7250;
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  padding: 10px 14px;
  cursor: pointer;
}

.btn-edit-decision {
  width: 100%;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  background: #ffffff;
  color: #334155;
  font-size: 12px;
  font-weight: 700;
  padding: 6px 8px;
  cursor: pointer;
  margin-top: auto;
}

/* üì± Responsive */
@media (max-width: 480px) {
  body {
    padding: 10px;
  }
  .container {
    padding: 16px;
    border-radius: 10px;
  }
  input, select, button {
    height: 46px;
    font-size: 15px;
  }
  .btn-primary {
    font-size: 15px;
  }
  .btn-add {
    font-size: 22px;
    height: 46px;
  }
  label {
    font-size: 14px;
  }
  .package-row {
    flex-direction: column;
  }
  .package-box,
  .actQty-box {
    flex: 1 1 100%;
  }
}
</style>
</head>

<body>
<div class="container">
  <div class="header-bar"><h3>üß™ Powder Inventory data check</h3></div>

  <div class="name-row" style="display:block;">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label>
    <div class="worker-cards">
      <div class="worker-card" data-worker="Wimol" onclick="selectWorker('Wimol', this)">üë§ Wimol</div>
      <div class="worker-card" data-worker="Wichit" onclick="selectWorker('Wichit', this)">üë§ Wichit</div>
    </div>
  </div>

  <div id="itemSection" style="display:none;">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone</label>
    <select id="customerSelect" onchange="onZoneChanged()"></select>

    <label style="margin-top:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</label>
    <select id="areaSelect" onchange="onAreaChanged()"></select>

    <div id="areaSetSection" style="margin-top:10px; display:none;">
      <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</label>
      <div id="areaSetList"></div>
    </div>
    <div id="confirmBar" class="confirm-bar">
      <button class="btn-confirm" onclick="confirmSubmitDecisions()">Confirm</button>
    </div>
    <select id="itemSelect" onchange="showDetail()" style="display:none;"></select>

    <div id="legacyActSection" style="display:none;">
    <div class="row2col" style="margin-top:10px;">
      <div class="col">
        <label>Product</label>
        <input id="customer" readonly>
      </div>
      <div class="col">
        <label>File</label>
        <input id="file5digit" readonly>
      </div>
    </div>

    <div class="row2col">
      <div class="col">
        <label>Lot</label>
        <input id="lot" readonly>
      </div>
      <div class="col">
        <label>Q'ty</label>
        <input id="sumQty" readonly>
      </div>
    </div>

    <label>Rack</label>
    <input id="rack" readonly>

    <div id="rackZone">
      <div class="rack-set" data-master="true">
        <div class="set-title">Act Set #1</div>
        <div class="action-buttons">
          <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
          <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
        </div>

        <label>Act Rack</label>
        <div class="row2col">
          <div class="col">
            <select class="rackGroup" onchange="updateRackSub(this)">
              <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="PCCHPAREA">PCCHPAREA</option>
              <option value="PCBKKAREA">PCBKKAREA</option>
              <option value="PCSUBSTORE">PCSUBSTORE</option>
            </select>
          </div>
          <div class="col">
            <select class="rackSub"></select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Act Lot</label>
          <input type="text" class="actLotInput">
        </div>

        <div class="package-row">
          <div class="package-box">
            <label>Package</label>
            <div class="package-inputs">
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input a"
       oninput="validateNumber(this); calcActQty(this)">
<span>√ó</span>
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input b"
       oninput="validateNumber(this); calcActQty(this)">
<span>+</span>
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input c"
       oninput="validateNumber(this); calcActQty(this)">

            </div>
          </div>
          <div class="actQty-box">
            <label>Act Q'ty</label>
            <input class="actQty" readonly>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:15px;">
<button class="btn-add" type="button" onclick="addRackSet()">Ôºã</button>
      <button class="btn-primary" style="flex:1;" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    </div>
  </div>

  <div class="footer">¬© 2026 Resonac Materials (Thailand) Co., Ltd.<br>Developed by IT Department</div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbw7DHUxP6S57hQ5soISQlXRfzQdtUZELXxTpUcQcCtkYRqHOaiFltqE7Flg3X5KDcKq/exec";
let currentItems = [];
let allSheetItems = [];
let selectedWorker = "";
let pendingDecisions = {};
const WORKERS = ["Wimol", "Wichit"];
const WIMOL_PREFIXES = new Set([
  "AA", "AB", "AC",
  "BA", "BB", "BC", "BD",
  "CA", "CB", "CC", "CD",
  "DA", "DB", "DC"
]);
const WORKER_ZONES = {
  Wimol: [
    "Zone : RM-RACK (A)",
    "Zone : RM-RACK (B)",
    "Zone : RM-RACK (C)",
    "Zone : RM-RACK (D)",
    "RESERVE-AREA"
  ],
  Wichit: [
    "Zone : RM-Zone (C)",
    "Zone : RM-Zone (D)",
    "Zone : RM-Zone (E)",
    "RESERVE-AREA"
  ]
};

const RM_ZONE_D_AREAS = (() => {
  const cols = ["D12", "D11", "D10", "D9", "D8", "D7", "D6", "D5", "D4", "D3", "D2", "D1"];
  const out = [];
  for (let n = 1; n <= 19; n++) {
    cols.forEach(c => out.push(`${c}-${n}`));
  }
  return out;
})();

const RM_ZONE_C_AREAS = (() => {
  const cols = ["C10", "C9", "C8", "C7", "C6", "C5", "C4", "C3", "C2", "C1"];
  const out = [];
  for (let n = 1; n <= 13; n++) {
    cols.forEach(c => out.push(`${c}-${n}`));
  }
  return out;
})();

const RM_ZONE_E_AREAS = (() => {
  const cols = ["E12", "E11", "E10", "E9", "E8", "E7", "E6", "E5", "E4", "E3", "E2", "E1"];
  const out = [];
  for (let n = 1; n <= 19; n++) {
    cols.forEach(c => out.push(`${c}-${n}`));
  }
  return out;
})();

const ZONE_STORAGE_MAP = {
  "Zone : RM-RACK (A)": [
    "AA-1", "AA-2", "AA-3", "AA-4", "AA-5", "AA-6", "AA-7",
    "AB-2", "AB-3", "AB-4", "AB-5", "AB-6", "AB-7",
    "AC-2", "AC-3", "AC-4", "AC-5", "AC-6", "AC-7"
  ],
  "Zone : RM-RACK (B)": [
    "BA-1", "BA-2", "BA-3", "BA-4", "BA-5", "BA-6",
    "BB-1", "BB-2", "BB-3", "BB-4", "BB-5", "BB-6",
    "BC-1", "BC-2", "BC-3", "BC-4", "BC-5", "BC-6",
    "BD-1", "BD-2", "BD-3", "BD-4", "BD-5", "BD-6"
  ],
  "Zone : RM-RACK (C)": [
    "CA-1", "CA-2", "CA-3", "CA-4", "CA-5", "CA-6",
    "CB-1", "CB-2", "CB-3", "CB-4", "CB-5", "CB-6",
    "CC-1", "CC-2", "CC-3", "CC-4", "CC-5", "CC-6",
    "CD-1", "CD-2", "CD-3", "CD-4", "CD-5", "CD-6"
  ],
  "Zone : RM-RACK (D)": [
    "DA-1", "DA-2", "DA-3", "DA-4", "DA-5", "DA-6", "DA-7",
    "DB-1", "DB-2", "DB-3", "DB-4", "DB-5", "DB-6", "DB-7",
    "DC-1", "DC-2", "DC-3", "DC-4", "DC-5", "DC-6", "DC-7"
  ],
  "Zone : RM-Zone (C)": RM_ZONE_C_AREAS,
  "Zone : RM-Zone (D)": RM_ZONE_D_AREAS,
  "Zone : RM-Zone (E)": RM_ZONE_E_AREAS
};

// Rack Map
const rackMap = {
  A: [
    "A-A01","A-A02","A-A03","A-A04","A-A05","A-A06","A-A07","A-A08",
    "A-B01","A-B02","A-B03","A-B04","A-B05","A-B06","A-B07","A-B08",
    "A-C01","A-C02","A-C03","A-C04","A-C05","A-C06","A-C07","A-C08",
    "A-D01","A-D02","A-D03","A-D04","A-D05","A-D06","A-D07","A-D08"
  ],
  
  B: Array.from({ length: 28 }, (_, i) => {
      const num = String(i + 1).padStart(2, '0');
      return ["B-A", "B-B", "B-C", "B-D"].map(p => `${p}${num}`);
    }).flat(),

  C: Array.from({ length: 36 }, (_, i) => {
      const num = String(i + 1).padStart(2, '0');
      return ["C-A", "C-B", "C-C", "C-D"].map(p => `${p}${num}`);
    }).flat(),
  
  D: [
    "D-A01","D-A02","D-A03","D-A04","D-A05","D-A06","D-A07","D-A08",
    "D-A09","D-A10","D-A11","D-A12","D-A13","D-A14","D-A15","D-A16","D-A17","D-A18","D-A19","D-A20","D-A21","D-A22",
    "D-B01","D-B02","D-B03","D-B04","D-B05","D-B06","D-B07","D-B08",
    "D-B09","D-B10","D-B11","D-B12","D-B13","D-B14","D-B15","D-B16","D-B17","D-B18","D-B19","D-B20","D-B21","D-B22"
  ]
};

// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å rack-set ‡∏°‡∏µ set-title + ‡∏à‡∏±‡∏î‡πÇ‡∏´‡∏°‡∏î edit/lock
function refreshRackSets() {
  const sets = document.querySelectorAll(".rack-set");

  sets.forEach((set, idx) => {

    // ‚≠ê Assign ID ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (!set.dataset.id) {
      set.dataset.id = idx === 0 ? "1" : "new";
    }

    // ‚≠ê ‡πÄ‡∏ã‡∏ï‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô master ‡πÄ‡∏™‡∏°‡∏≠
    const isMaster = idx === 0;
    set.dataset.master = isMaster ? "true" : "false";

    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å Database ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isLoadedFromDB = set.dataset.loaded === "true";

    // -------------------------
    // 1. Update Title
    // -------------------------
    let title = set.querySelector(".set-title");
    if (!title) {
      title = document.createElement("div");
      title.className = "set-title";
      set.prepend(title);
    }
    title.textContent = `Act Set #${idx + 1}`;

    // -------------------------
    // 2. ‡∏õ‡∏∏‡πà‡∏° Edit / Delete
    // -------------------------
    const editBtn = set.querySelector(".btn-edit");
    const delBtn  = set.querySelector(".btn-delete");

    // ================================
    // ‚≠ê CASE A: ‡πÄ‡∏ã‡∏ï‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
    // ================================
    if (!isLoadedFromDB) {

      // Master ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏ï‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‚Üí Editable
      if (editBtn) {
        editBtn.dataset.editing = "true";
        editBtn.textContent = "üîí";
        editBtn.style.background = "#10b981";
      }

      if (delBtn) {
        delBtn.style.display = isMaster ? "none" : "inline-flex";
      }

      // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç input/select
      set.querySelectorAll("input").forEach(el => {
        if (!el.classList.contains("actQty")) {
          el.readOnly = false;
          el.classList.add("editable");
        }
      });

      set.querySelectorAll("select").forEach(el => {
        el.disabled = false;
        el.classList.add("editable");
      });

      return;   // ‚¨Ö ‡∏à‡∏ö ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    }

    // =====================================
    // ‚≠ê CASE B: ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å DATABASE ‚Üí ‡∏ï‡πâ‡∏≠‡∏á Lock
    // =====================================
    if (editBtn) {
      editBtn.dataset.editing = "false";
      editBtn.textContent = "‚úèÔ∏è";
      editBtn.style.background = "#3b82f6";
    }

    if (delBtn) {
      delBtn.style.display = isMaster ? "none" : "inline-flex";
    }

    // Lock fields
    set.querySelectorAll("input").forEach(el => {
      if (!el.classList.contains("actQty")) {
        el.readOnly = true;
        el.classList.remove("editable");
      }
    });

    set.querySelectorAll("select").forEach(el => {
      el.disabled = true;
      el.classList.remove("editable");
    });

  });
}


refreshRackSets();

function resetWorkerView() {
  // Clear all dependent UI before loading a new worker
  itemSection.style.display = "none";
  customerSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone --</option>`;
  areaSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö --</option>`;
  areaSelect.disabled = true;
  itemSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product --</option>`;
  areaSetSection.style.display = "none";
  areaSetList.innerHTML = "";
  confirmBar.style.display = "none";
}

function selectWorker(workerName, el) {
  selectedWorker = workerName;
  document.querySelectorAll(".worker-card").forEach(card => card.classList.remove("active"));
  if (el) el.classList.add("active");
  resetWorkerView();
  fetchItems(workerName);
}

async function fetchItems(workerName = selectedWorker) {
  const name = workerName;
  if (!name) {
    return Swal.fire("‚ö†Ô∏è", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥", "warning");
  }
  pendingDecisions = {};
  confirmBar.style.display = "none";

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=ALL`);
    const rows = await res.json();
    Swal.close();

    if (!rows || rows.length === 0) {
      resetWorkerView();
      return Swal.fire("‚ÑπÔ∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ", "info");
    }

    allSheetItems = rows;
    currentItems = rows.filter(r => isAssignedToWorker(name, getStorageArea(r)));

    if (currentItems.length === 0) {
      resetWorkerView();
      return Swal.fire("‚ÑπÔ∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Zone ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ", "info");
    }

    loadZones(name);
    itemSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product --</option>`;
    itemSection.style.display = "block";
  } catch {
    resetWorkerView();
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
  }
}

function getStorageArea(row) {
  return String(row.Rack || row["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").trim();
}

function normalizeArea(area) {
  return String(area || "")
    .replace(/\[.*?\]/g, "")
    .replace(/\s+/g, "")
    .toUpperCase();
}

function normalizeStorageCode(area) {
  return normalizeArea(area).replace(/-/g, "");
}

function makeRowKey(file5, lotVal, rackVal) {
  return `${String(file5 || "").trim()}||${String(lotVal || "").trim()}||${normalizeStorageCode(rackVal)}`;
}

function updateConfirmBar() {
  const hasPending = Object.values(pendingDecisions).some(v => {
    if (typeof v === "string") return v === "YES" || v === "NO";
    return v && (v.decision === "YES" || v.decision === "NO");
  });
  confirmBar.style.display = hasPending ? "block" : "none";
}

function clearPendingSelections() {
  pendingDecisions = {};
  confirmBar.style.display = "none";
}

function onZoneChanged() {
  clearPendingSelections();
  filterItemsByZone();
}

function onAreaChanged() {
  clearPendingSelections();
  filterItemsByStorageArea();
}

function getPendingDecision(rowKey) {
  const entry = pendingDecisions[rowKey];
  if (!entry) return { decision: "" };
  if (typeof entry === "string") return { decision: entry };
  return entry;
}

function findBaseRowByKey(rowKey) {
  const [file5, lotVal, rackKey] = String(rowKey || "").split("||");
  return currentItems.find(r =>
    String(r.ID).trim() === "1" &&
    String(r.File5digit).trim() === file5 &&
    String(r.Lot).trim() === lotVal &&
    normalizeStorageCode(String(r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim()) === rackKey
  );
}

function cleanProductText(product) {
  return String(product || "")
    .replace(/^\s*(?:\[[^\]]*\]\s*)+/, "")
    .trim();
}

function isReserveArea(area) {
  const normalized = normalizeArea(area);
  return normalized.includes("RESERVE-AREA") || normalized.includes("RESERVEAREA");
}

function getWimolRackZone(area) {
  const normalized = normalizeArea(area);
  const twoChar = normalized.slice(0, 2);
  if (!WIMOL_PREFIXES.has(twoChar)) return "";
  const rackPrefix = twoChar.slice(0, 1);
  if (rackPrefix === "A") return "Zone : RM-RACK (A)";
  if (rackPrefix === "B") return "Zone : RM-RACK (B)";
  if (rackPrefix === "C") return "Zone : RM-RACK (C)";
  if (rackPrefix === "D") return "Zone : RM-RACK (D)";
  return "";
}

function getWichitZone(area) {
  const normalized = normalizeArea(area);
  const twoChar = normalized.slice(0, 2);
  if (WIMOL_PREFIXES.has(twoChar) || isReserveArea(normalized)) return "";

  if (normalized.startsWith("C")) return "Zone : RM-Zone (C)";
  if (normalized.startsWith("D")) return "Zone : RM-Zone (D)";
  return "Zone : RM-Zone (E)";
}

function getZoneForWorker(workerName, area) {
  const worker = String(workerName || "").trim();
  if (isReserveArea(area)) {
    return (worker === "Wimol" || worker === "Wichit") ? "RESERVE-AREA" : "";
  }
  if (worker === "Wimol") return getWimolRackZone(area);
  if (worker === "Wichit") return getWichitZone(area);
  return "";
}

function isAssignedToWorker(workerName, area) {
  return !!getZoneForWorker(workerName, area);
}

function showDetail() {
  try {
    const value = itemSelect.value;

    // -----------------------------------------
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí reset ‡πÄ‡∏õ‡πá‡∏ô Act Set #1 ‡∏ß‡πà‡∏≤‡∏á
    // -----------------------------------------
    if (!value) {
      customer.value = "";
      file5digit.value = "";
      lot.value = "";
      sumQty.value = "";
      rack.value = "";

      document.getElementById("rackZone").innerHTML = `
         <div class="rack-set" data-master="true" data-id="1" data-loaded="false">
          <div class="set-title">Act Set #1</div>
          <div class="action-buttons">
            <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
            <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
          </div>

          <label>Act Rack</label>
          <div class="row2col">
            <div class="col">
              <select class="rackGroup" onchange="updateRackSub(this)">
                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="PCCHPAREA">PCCHPAREA</option>
                <option value="PCBKKAREA">PCBKKAREA</option>
                <option value="PCSUBSTORE">PCSUBSTORE</option>
              </select>
            </div>
            <div class="col"><select class="rackSub"></select></div>
          </div>

          <div style="margin-top:10px;">
            <label>Act Lot</label>
            <input type="text" class="actLotInput">
          </div>

          <div class="package-row">
            <div class="package-box">
              <label>Package</label>
              <div class="package-inputs">
                <input type="text" inputmode="numeric" pattern="[0-9]*"
                       class="pkg-input a" oninput="validateNumber(this); calcActQty(this)">
                <span>√ó</span>
                <input type="text" inputmode="numeric" pattern="[0-9]*"
                       class="pkg-input b" oninput="validateNumber(this); calcActQty(this)">
                <span>+</span>
                <input type="text" inputmode="numeric" pattern="[0-9]*"
                       class="pkg-input c" oninput="validateNumber(this); calcActQty(this)">
              </div>
            </div>
            <div class="actQty-box">
              <label>Act Q'ty</label>
              <input class="actQty" readonly>
            </div>
          </div>
        </div>
      `;
      refreshRackSets();
      return;
    }

    // -----------------------------------------
    // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤ File | Lot | Rack ‡πÄ‡∏î‡∏¥‡∏°
    // -----------------------------------------
    const [fileCode, lotCode, rackName] = value.split("|");
    if (!fileCode || !lotCode) return;

    // -----------------------------------------
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà File + Lot + Rack ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
    // -----------------------------------------
    const selectedRows = currentItems.filter(r => {
      return (
        String(r.File5digit).trim() === fileCode.trim() &&
        String(r.Lot).trim()        === lotCode.trim() &&
        String(r.Rack).replace(/\[.*?\]/g, "").trim() === rackName.trim()
      );
    });

    if (selectedRows.length === 0) {
      return Swal.fire("‚ö†Ô∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", "warning");
    }

    // ‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô base
    const base = selectedRows[0];
    const getVal = key => {
      const found = Object.keys(base).find(k => k.trim().toLowerCase() === key.toLowerCase());
      return found ? base[found] : "";
    };

    customer.value  = getVal("Customer");
    file5digit.value = getVal("File5digit");
    lot.value       = getVal("Lot");
    rack.value      = getVal("Rack");
    sumQty.value    = getVal("Sum of Qty") || getVal("SumOfQty") || "";

    // -----------------------------------------
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á rack-set ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    // -----------------------------------------
    let htmlRack = "";

    selectedRows.forEach((row, index) => {

      // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "new"
      let rawId =
        row.ID !== undefined ? row.ID :
        row.Id !== undefined ? row.Id :
        row.id;

      let idStr = (rawId === undefined || rawId === null || rawId === "") ? "new" : String(rawId);

      const isMaster = (idStr === "1");

      const actRack   = row.Act_Rack    || "";
      const rawActLot = row.Act_Lot;
      const actLotVal = rawActLot || row.Lot || "";
      const actPkg    = row.Act_Package || "";
      const actQty    = row.Act_Qty     || "";

      const pkgA = actPkg ? (actPkg.split("√ó")[0] || "") : "";
      const pkgB = actPkg ? ((actPkg.split("√ó")[1] || "").split("+")[0] || "") : "";
      const pkgC = actPkg ? ((actPkg.split("+")[1] || "") || "") : "";

      htmlRack += `
        <div class="rack-set" data-id="${idStr}" data-master="${isMaster ? "true" : "false"}" data-loaded="true">

          <div class="set-title">Act Set #${index + 1}</div>

          <div class="action-buttons">
            <button class="btn-edit" data-editing="false" onclick="toggleEdit(this)">‚úèÔ∏è</button>
            ${isMaster ? "" : '<button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>'}
          </div>

          <label>Act Rack</label>
          <div class="row2col">
            <div class="col">
              <select class="rackGroup" onchange="updateRackSub(this)" ${actRack ? "disabled" : ""}>
                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
                <option value="A" ${actRack.startsWith("A") ? "selected" : ""}>A</option>
                <option value="B" ${actRack.startsWith("B") ? "selected" : ""}>B</option>
                <option value="C" ${actRack.startsWith("C") ? "selected" : ""}>C</option>
                <option value="D" ${actRack.startsWith("D") ? "selected" : ""}>D</option>
                <option value="PCCHPAREA" ${actRack === "PCCHPAREA" ? "selected" : ""}>PCCHPAREA</option>
                <option value="PCBKKAREA" ${actRack === "PCBKKAREA" ? "selected" : ""}>PCBKKAREA</option>
                <option value="PCSUBSTORE" ${actRack === "PCSUBSTORE" ? "selected" : ""}>PCSUBSTORE</option>
              </select>
            </div>
            <div class="col">
              <select class="rackSub" ${actRack ? "disabled" : ""}>
                ${actRack ? `<option value="${actRack}" selected>${actRack}</option>` : ""}
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>Act Lot</label>
            <input type="text" class="actLotInput" value="${actLotVal}" ${rawActLot ? "readonly" : ""}>
          </div>

          <div class="package-row">
            <div class="package-box">
              <label>Package</label>
              <div class="package-inputs">
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input a"
       value="${pkgA}"
       ${actPkg ? "readonly" : ""}
       oninput="validateNumber(this); calcActQty(this)">
<span>√ó</span>

<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input b"
       value="${pkgB}"
       ${actPkg ? "readonly" : ""}
       oninput="validateNumber(this); calcActQty(this)">
<span>+</span>

<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input c"
       value="${pkgC}"
       ${actPkg ? "readonly" : ""}
       oninput="validateNumber(this); calcActQty(this)">

              </div>
            </div>
            <div class="actQty-box">
              <label>Act Q'ty</label>
              <input class="actQty" readonly value="${actQty}">
            </div>
          </div>
        </div>
      `;
    });

    // -------------------------------
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ rack-set ‡πÄ‡∏•‡∏¢ ‚Üí Create Act Set #1
    // -------------------------------
    if (!htmlRack) {
      htmlRack = `
        <div class="rack-set" data-master="true" data-id="1" data-loaded="false">
          <div class="set-title">Act Set #1</div>
          <div class="action-buttons">
            <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
          </div>

          <label>Act Rack</label>
          <div class="row2col">
            <div class="col">
              <select class="rackGroup" onchange="updateRackSub(this)">
                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="PCCHPAREA">PCCHPAREA</option>
                <option value="PCBKKAREA">PCBKKAREA</option>
                <option value="PCSUBSTORE">PCSUBSTORE</option>
              </select>
            </div>
            <div class="col"><select class="rackSub"></select></div>
          </div>

          <div style="margin-top:10px;">
            <label>Act Lot</label>
            <input class="actLotInput" value="${lotCode}">
          </div>

          <div class="package-row">
            <div class="package-box">
              <label>Package</label>
              <div class="package-inputs">
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input a" oninput="validateNumber(this); calcActQty(this)">
<span>√ó</span>
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input b" oninput="validateNumber(this); calcActQty(this)">
<span>+</span>
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input c" oninput="validateNumber(this); calcActQty(this)">

              </div>
            </div>
            <div class="actQty-box">
              <label>Act Q'ty</label>
              <input class="actQty" readonly>
            </div>
          </div>
        </div>
      `;
    }

    document.getElementById("rackZone").innerHTML = htmlRack;
    refreshRackSets();

  } catch (err) {
    console.error("showDetail error:", err);
    Swal.fire("‚ùå", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ", "error");
  }
}


function updateRackSub(select) {
  const subSelect = select.closest(".rack-set").querySelector(".rackSub");
  const group = select.value;

  if (group === "PCCHPAREA" || group === "PCBKKAREA" || group === "PCSUBSTORE") {
    subSelect.innerHTML = `<option value="${group}" selected>${group}</option>`;
    return;
  }

if (group) {
  const sorted = rackMap[group].sort((a, b) => {
    const pa = a.split("-");
    const pb = b.split("-");
    const sectionA = pa[1].substring(0, 1);
    const sectionB = pb[1].substring(0, 1);
    const numA = parseInt(pa[1].substring(1), 10);
    const numB = parseInt(pb[1].substring(1), 10);

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á A ‚Üí B ‚Üí C ‚Üí D ‡∏Å‡πà‡∏≠‡∏ô
    if (sectionA !== sectionB) return sectionA.localeCompare(sectionB);
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç
    return numA - numB;
  });

  subSelect.innerHTML = sorted
    .map(v => `<option value="${v}">${v}</option>`)
    .join("");
} else {
  subSelect.innerHTML = "";
}
}

function calcActQty(input) {
  const p = input.closest(".rack-set");
  const a = +p.querySelector(".pkg-input.a").value || 0;
  const b = +p.querySelector(".pkg-input.b").value || 0;
  const c = +p.querySelector(".pkg-input.c").value || 0;
  p.querySelector(".actQty").value = (a * b) + c;
}

function addRackSet() {
  const zone = document.getElementById("rackZone");

  const newSet = document.createElement("div");
  newSet.className = "rack-set";
  newSet.dataset.master = "false";
  newSet.dataset.id = "new"; // ‚≠ê ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ new ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ code.gs ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà

  newSet.innerHTML = `
    <div class="set-title">Act Set #?</div>
    <div class="action-buttons">
      <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
      <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
    </div>

    <label>Act Rack</label>
    <div class="row2col">
      <div class="col">
        <select class="rackGroup" onchange="updateRackSub(this)">
          <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="PCCHPAREA">PCCHPAREA</option>
          <option value="PCBKKAREA">PCBKKAREA</option>
          <option value="PCSUBSTORE">PCSUBSTORE</option>
        </select>
      </div>
      <div class="col"><select class="rackSub"></select></div>
    </div>

    <div style="margin-top:10px;">
      <label>Act Lot</label>
      <input type="text" class="actLotInput" value="${lot.value}">
    </div>

    <div class="package-row">
      <div class="package-box">
        <label>Package</label>
        <div class="package-inputs">
          <input type="text" inputmode="numeric" pattern="[0-9]*"
                 class="pkg-input a"
                 oninput="validateNumber(this); calcActQty(this)">
          <span>√ó</span>
          <input type="text" inputmode="numeric" pattern="[0-9]*"
                 class="pkg-input b"
                 oninput="validateNumber(this); calcActQty(this)">
          <span>+</span>
          <input type="text" inputmode="numeric" pattern="[0-9]*"
                 class="pkg-input c"
                 oninput="validateNumber(this); calcActQty(this)">
        </div>
      </div>

      <div class="actQty-box">
        <label>Act Q'ty</label>
        <input class="actQty" readonly>
      </div>
    </div>
  `;

  zone.appendChild(newSet);
  refreshRackSets();
}

async function removeRackSet(btn) {
  const rackSet = btn.closest(".rack-set");
  const isMaster = rackSet.dataset.master === "true";
  if (isMaster) return;

  const rackId = rackSet.dataset.id;

  // ‚≠ê ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà (ID = new) ‚Üí ‡∏•‡∏ö UI ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
  if (!rackId || rackId === "new") {
    rackSet.remove();
    refreshRackSets();
    return;
  }

  // ‚≠ê ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ID ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏ö‡πÉ‡∏ô Google Sheet
  const actRack = rackSet.querySelector(".rackSub").value.trim();
  const file = file5digit.value.trim();
  const lotVal = lot.value.trim();
const name = selectedWorker.trim();
  const originalRack = rack.value.replace(/\[.*?\]/g, "").trim();

  const confirm = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?",
    text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Rack ${actRack} ‡∏Ç‡∏≠‡∏á ${file} (${lotVal}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`,
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡∏•‡∏ö",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });
  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(`${scriptURL}?page=deleteRecord`, {
      method: "POST",
      body: new URLSearchParams({
        name,
        file5digit: file,
        lot: lotVal,
        originalRack,
        id: rackId
      })
    });

    const result = await res.json();
    Swal.close();

    if (result.success) {
      rackSet.remove();
      refreshRackSets();
      Swal.fire("‚úÖ", "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
    } else {
      Swal.fire("‚ö†Ô∏è", result.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "warning");
    }
  } catch (err) {
    Swal.close();
    Swal.fire("‚ùå", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
    console.error(err);
  }
}


function toggleEdit(btn) {
  const rack = btn.closest(".rack-set");
  const isEditing = btn.dataset.editing !== "true"; // toggle

  btn.dataset.editing = isEditing ? "true" : "false";
  btn.textContent = isEditing ? "üîí" : "‚úèÔ∏è";
  btn.style.background = isEditing ? "#10b981" : "#3b82f6";

  rack.querySelectorAll("input").forEach(el => {
    if (el.classList.contains("actQty")) return;
    el.readOnly = !isEditing;
    el.classList.toggle("editable", isEditing);
  });

  rack.querySelectorAll("select").forEach(el => {
    el.disabled = !isEditing;
    el.classList.toggle("editable", isEditing);
  });
}

async function saveData() {
const name = selectedWorker;
  const file = file5digit.value.trim();
  const itemValue = itemSelect.value;
  const sets = document.querySelectorAll(".rack-set");

  let originalRack = rack.value.replace(/\[.*?\]/g, "").trim();

  // ‚≠ê FIX: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Act Rack ‡∏Ç‡∏≠‡∏á master set ‡πÅ‡∏ó‡∏ô
  if (!originalRack) {
    const master = document.querySelector(".rack-set[data-master='true']");
    if (master) {
      const g = master.querySelector(".rackGroup")?.value.trim() || "";
      const s = master.querySelector(".rackSub")?.value.trim() || "";
      originalRack = s || g || "";
    }
  }

  const customerVal = customer.value.trim();
  const sumQtyVal = sumQty.value.trim();

  if (!itemValue) {
    return Swal.fire({
      icon: "warning",
      title: "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
    });
  }

  //----------------------------------------------
  // VALIDATE ‡∏ó‡∏∏‡∏Å rack-set ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö
  //----------------------------------------------
//----------------------------------------------
// VALIDATE ‡∏ó‡∏∏‡∏Å rack-set ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö
//----------------------------------------------
for (const s of sets) {

  const group = s.querySelector(".rackGroup").value.trim();
  const sub   = s.querySelector(".rackSub").value.trim();
  const actRack = (group && sub) ? sub : "";

  const actLot = s.querySelector(".actLotInput").value.trim();
  const a = s.querySelector(".pkg-input.a").value.trim();
  const b = s.querySelector(".pkg-input.b").value.trim();
  const c = s.querySelector(".pkg-input.c").value.trim() || "0";
  const actQty = s.querySelector(".actQty").value.trim();

  // ‚ùó ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Act Rack ‡∏ó‡∏∏‡∏Å‡∏ä‡∏∏‡∏î ‡∏£‡∏ß‡∏° Act Set #1
  if (!actRack) {
    return Swal.fire({
      icon: "warning",
      title: "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Act Rack",
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
    });
  }

  // ‚ùó ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å Act Lot ‡πÅ‡∏•‡∏∞ Package
  if (!actLot || !a || !b || !actQty) {
    return Swal.fire({
      icon: "warning",
      title: "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á",
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
    });
  }
}


  //----------------------------------------------
  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  //----------------------------------------------
  const confirm = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });
  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  //----------------------------------------------
  // POST ‡πÑ‡∏õ code.gs ‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏∏‡∏î
  //----------------------------------------------
  for (const s of sets) {
    const isMaster = s.dataset.master === "true";
    const group = s.querySelector(".rackGroup").value.trim();
    const sub   = s.querySelector(".rackSub").value.trim();
    let actRack = group && sub ? sub : "";
    const actLot = s.querySelector(".actLotInput").value.trim();

    let a = s.querySelector(".pkg-input.a").value.trim();
    let b = s.querySelector(".pkg-input.b").value.trim();
    let c = s.querySelector(".pkg-input.c").value.trim() || "0";
    const actQty = s.querySelector(".actQty").value.trim();

    if (isMaster && !actRack) actRack = originalRack;

    const actPackage = `${a}√ó${b}+${c}`;
    const rackId = s.dataset.id || "";

    await fetch(`${scriptURL}?page=updateRecord`, {
      method: "POST",
      body: new URLSearchParams({
        name,
        recorder: name,
        file5digit: file,
        lot: lot.value,
        originalRack,
        customer: customerVal,
        sumQty: sumQtyVal,
        actRack,
        actLot,
        actQty,
        actPackage,
        rackId
      })
    });
  }

  Swal.close();
  await Swal.fire({ icon: "success", title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" });

// ‚≠ê ‡∏à‡∏≥ Zone/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
const lastSelectedZone = customerSelect.value;
const lastSelectedArea = areaSelect.value;

clearForm();
await fetchItems();

// ‚≠ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone ‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
customerSelect.value = lastSelectedZone;
filterItemsByZone();
areaSelect.value = lastSelectedArea;
filterItemsByStorageArea();

}

function clearForm() {
  pendingDecisions = {};
  confirmBar.style.display = "none";
  customer.value = "";
  file5digit.value = "";
  lot.value = "";
  sumQty.value = "";
  rack.value = "";
  itemSelect.value = "";

  const zone = document.getElementById("rackZone");
  zone.innerHTML = `
    <div class="rack-set" data-master="true" data-id="1" data-loaded="false">
      <div class="set-title">Act Set #1</div>
      <div class="action-buttons">
        <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
        <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
      </div>

      <label>Act Rack</label>
      <div class="row2col">
        <div class="col">
          <select class="rackGroup" onchange="updateRackSub(this)">
            <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="PCCHPAREA">PCCHPAREA</option>
            <option value="PCBKKAREA">PCBKKAREA</option>
            <option value="PCSUBSTORE">PCSUBSTORE</option>
          </select>
        </div>
        <div class="col"><select class="rackSub"></select></div>
      </div>

      <div style="margin-top:10px;">
        <label>Act Lot</label>
        <input type="text" class="actLotInput">
      </div>

      <div class="package-row">
        <div class="package-box">
          <label>Package</label>
          <div class="package-inputs">
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input a"
       oninput="validateNumber(this); calcActQty(this)">
<span>√ó</span>
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input b"
       oninput="validateNumber(this); calcActQty(this)">
<span>+</span>
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input c"
       oninput="validateNumber(this); calcActQty(this)">
          </div>
        </div>
        <div class="actQty-box">
          <label>Act Q'ty</label>
          <input class="actQty" readonly>
        </div>
      </div>
    </div>
  `;
  document.getElementById("itemSection").style.display = "none";
  refreshRackSets();
}

function validateNumber(el) {
  el.value = el.value.replace(/[^0-9]/g, "");
}

function loadZones(workerName) {
  const zones = WORKER_ZONES[workerName] || [];
  customerSelect.innerHTML =
    `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone --</option>` +
    zones.map(zone => {
      const icon = getZoneStatusIcon(workerName, zone);
      return `<option value="${zone}">${zone} ${icon}</option>`;
    }).join("");

  areaSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö --</option>`;
  areaSelect.disabled = true;
  itemSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product --</option>`;
}

function naturalAreaCompare(a, b) {
  return String(a || "").localeCompare(String(b || ""), undefined, {
    numeric: true,
    sensitivity: "base"
  });
}

function getAreasForZone(workerName, zoneName) {
  const zone = String(zoneName || "").trim();
  const matchedKey = Object.keys(ZONE_STORAGE_MAP).find(k => String(k).trim() === zone);
  const fixedAreas = ZONE_STORAGE_MAP[zone] || (matchedKey ? ZONE_STORAGE_MAP[matchedKey] : null);
  if (fixedAreas && fixedAreas.length) return [...fixedAreas].sort(naturalAreaCompare);

  return [...new Set(
    currentItems
      .filter(r => String(getZoneForWorker(workerName, getStorageArea(r))).trim() === zone)
      .map(r => String(r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim())
      .filter(Boolean)
  )].sort(naturalAreaCompare);
}

function getAreaStatusIcon(workerName, zoneName, areaName) {
  const baseRows = currentItems.filter(r => {
    if (String(r.ID).trim() !== "1") return false;
    const zone = getZoneForWorker(workerName, getStorageArea(r));
    const rack = String(r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim();
    return zone === zoneName && normalizeStorageCode(rack) === normalizeStorageCode(areaName);
  });

  // ‡πÑ‡∏°‡πà‡∏°‡∏µ Product ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ
  if (baseRows.length === 0) return "‚úÖ";

  const allDone = baseRows.every(base => {
    const rackVal = String(base.Rack || base["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim();
    const rowKey = makeRowKey(base.File5digit, base.Lot, rackVal);
    const pending = getPendingDecision(rowKey);
    if (pending.decision === "YES" || pending.decision === "NO") return true;
    if (pending.decision === "EDIT") return false;

    const persisted = String(base["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"] ?? base.Act_Package ?? "").trim().toUpperCase();
    return persisted === "YES" || persisted === "NO";
  });

  return allDone ? "‚úÖ" : "‚ö™";
}

function getZoneStatusIcon(workerName, zoneName) {
  const areas = getAreasForZone(workerName, zoneName);
  if (!areas || areas.length === 0) return "‚úÖ";
  const allDone = areas.every(area => getAreaStatusIcon(workerName, zoneName, area) === "‚úÖ");
  return allDone ? "‚úÖ" : "‚ö™";
}

function refreshStatusOptionIcons() {
  const workerName = selectedWorker;
  if (!workerName) return;

  const selectedZone = customerSelect.value;
  const selectedArea = areaSelect.value;

  const zones = WORKER_ZONES[workerName] || [];
  customerSelect.innerHTML =
    `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Zone --</option>` +
    zones.map(zone => {
      const icon = getZoneStatusIcon(workerName, zone);
      return `<option value="${zone}">${zone} ${icon}</option>`;
    }).join("");
  customerSelect.value = selectedZone;

  areaSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö --</option>`;
  areaSelect.disabled = !selectedZone;
  if (!selectedZone) return;

  if (selectedZone === "RESERVE-AREA") {
    const reserveAreaLabel = "Reserve-Area";
    const icon = getAreaStatusIcon(workerName, selectedZone, reserveAreaLabel);
    areaSelect.innerHTML = `<option value="${reserveAreaLabel}">${reserveAreaLabel} ${icon}</option>`;
    areaSelect.value = reserveAreaLabel;
    return;
  }

  const areas = getAreasForZone(workerName, selectedZone);
  areaSelect.innerHTML =
    `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö --</option>` +
    areas.map(area => {
      const icon = getAreaStatusIcon(workerName, selectedZone, area);
      return `<option value="${area}">${area} ${icon}</option>`;
    }).join("");
  areaSelect.value = selectedArea;
}

function filterItemsByZone() {
  const selectedZone = customerSelect.value;

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°
  customer.value = "";
  file5digit.value = "";
  lot.value = "";
  sumQty.value = "";
  rack.value = "";

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï rackZone -> Act Set #1 (‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
  document.getElementById("rackZone").innerHTML = `
    <div class="rack-set" data-master="true" data-id="1" data-loaded="false">
      <div class="set-title">Act Set #1</div>
      <div class="action-buttons">
        <button class="btn-edit" data-editing="true" onclick="toggleEdit(this)">üîí</button>
        <button class="btn-delete" onclick="removeRackSet(this)">üóëÔ∏è</button>
      </div>

      <label>Act Rack</label>
      <div class="row2col">
        <div class="col">
          <select class="rackGroup" onchange="updateRackSub(this)">
            <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="PCCHPAREA">PCCHPAREA</option>
            <option value="PCBKKAREA">PCBKKAREA</option>
            <option value="PCSUBSTORE">PCSUBSTORE</option>
          </select>
        </div>
        <div class="col"><select class="rackSub"></select></div>
      </div>

      <div style="margin-top:10px;">
        <label>Act Lot</label>
        <input type="text" class="actLotInput">
      </div>

      <div class="package-row">
        <div class="package-box">
          <label>Package</label>
          <div class="package-inputs">
<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input a" oninput="validateNumber(this); calcActQty(this)">

<span>√ó</span>

<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input b" oninput="validateNumber(this); calcActQty(this)">

<span>+</span>

<input type="text" inputmode="numeric" pattern="[0-9]*"
       class="pkg-input c" oninput="validateNumber(this); calcActQty(this)">


          </div>
        </div>
        <div class="actQty-box">
          <label>Act Q'ty</label>
          <input class="actQty" readonly>
        </div>
      </div>
    </div>
  `;
  refreshRackSets();

  const workerName = selectedWorker;
  areaSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö --</option>`;
  areaSelect.disabled = true;
  itemSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product --</option>`;
  areaSetSection.style.display = "none";
  areaSetList.innerHTML = "";
  confirmBar.style.display = "none";
  if (!selectedZone) return;

  areaSelect.disabled = false;
  const areas = getAreasForZone(workerName, selectedZone);
  // RESERVE-AREA: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  if (selectedZone === "RESERVE-AREA") {
    const reserveAreaLabel = "Reserve-Area";
    const icon = getAreaStatusIcon(workerName, selectedZone, reserveAreaLabel);
    areaSelect.innerHTML = `<option value="${reserveAreaLabel}">${reserveAreaLabel} ${icon}</option>`;
    areaSelect.value = reserveAreaLabel;
    filterItemsByStorageArea();
    return;
  }

  areaSelect.innerHTML =
    `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö --</option>` +
    areas.map(area => {
      const icon = getAreaStatusIcon(workerName, selectedZone, area);
      return `<option value="${area}">${area} ${icon}</option>`;
    }).join("");
}

function filterItemsByStorageArea() {
  const selectedZone = customerSelect.value;
  const selectedArea = areaSelect.value;
  const workerName = selectedWorker;
  const list = document.getElementById("itemSelect");
  list.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product --</option>`;
  areaSetSection.style.display = "none";
  areaSetList.innerHTML = "";
  confirmBar.style.display = "none";
  if (!selectedZone || !selectedArea) return;

  const rows = currentItems.filter(r => {
    const zone = getZoneForWorker(workerName, getStorageArea(r));
    const cleanRack = String(r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "")
      .replace(/\[.*?\]/g, "")
      .trim();
    return zone === selectedZone && normalizeStorageCode(cleanRack) === normalizeStorageCode(selectedArea);
  });

  const baseRows = rows.filter(r => String(r.ID).trim() === "1");
  renderAreaSetCards(baseRows);

}

function getDecisionState(baseRow) {
  const resultRaw = String(baseRow["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"] ?? baseRow.Act_Package ?? "").trim().toUpperCase();
  if (resultRaw === "YES" || resultRaw === "NO") return resultRaw;

  const cleanRack = String(baseRow.Rack || baseRow["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim();
  const sumQty = Number(baseRow["Sum of Qty"] || baseRow.SumOfQty || 0);
  const related = currentItems.filter(item =>
    String(item.File5digit).trim() === String(baseRow.File5digit).trim() &&
    String(item.Lot).trim() === String(baseRow.Lot).trim() &&
    normalizeStorageCode(String(item.Rack || item["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim()) === normalizeStorageCode(cleanRack)
  );
  const totalActQty = related.reduce((sum, it) => sum + Number(it.Act_Qty || 0), 0);
  if (totalActQty <= 0) return "PENDING";
  return totalActQty === sumQty ? "YES" : "NO";
}

function renderAreaSetCards(rows) {
  areaSetSection.style.display = "block";
  if (!rows || rows.length === 0) {
    areaSetList.innerHTML = `<div class="area-set-card">‡πÑ‡∏°‡πà‡∏°‡∏µ Product ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  areaSetList.innerHTML = rows.map(r => {
    const product = cleanProductText(r.Customer || r.Product || "");
    const d365 = String(r.File5digit || r["D365 Code"] || "").trim();
    const lotVal = String(r.Lot || r["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] || "").trim();
    const qtyVal = String(r["Sum of Qty"] || r.SumOfQty || r["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || "").trim();
    const uomVal = String(r.Name || r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"] || "").trim();
    const rackVal = String(r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim();
    const rowKey = makeRowKey(d365, lotVal, rackVal);
    const pending = getPendingDecision(rowKey);
    const replacementRow = pending.replacementKey ? findBaseRowByKey(pending.replacementKey) : null;
    const replacementIsNone = pending.replacementKey === "__NONE__";
    const persistedNewProduct = cleanProductText(r["Product‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? r.Act_Rack ?? "");
    const persistedNewD365 = String(r["D365 Code‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? r.Act_D365Code ?? "").trim();
    const persistedNewLot = String(r["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? r.Act_Lot ?? "").trim();
    const persistedNewQty = String(r["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? r.Act_Qty ?? "").trim();
    const persistedNewUom = String(r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á"] ?? r.Act_Uom ?? "").trim();
    const hasPersistedReplacement =
      !!(persistedNewProduct || persistedNewD365 || persistedNewLot || persistedNewQty || persistedNewUom);
    const persistedState = getDecisionState(r);
    const stateRaw = pending.decision || persistedState || "PENDING";
    const state = stateRaw === "EDIT" ? "PENDING" : stateRaw;

    const replacementHtml = state === "NO" && (replacementRow || replacementIsNone || hasPersistedReplacement)
      ? `
          <div class="area-set-row">
            <div class="area-set-key">Product</div>
            <div class="area-set-val"><span class="old-val">${product || "-"}</span>  <span class="new-val">${
              replacementIsNone ? "‡πÑ‡∏°‡πà‡∏°‡∏µ" :
              replacementRow ? cleanProductText(replacementRow.Customer || replacementRow.Product || "-") :
              (persistedNewProduct || "-")
            }</span></div>
          </div>
          <div class="area-set-row">
            <div class="area-set-key">D365 Code</div>
            <div class="area-set-val"><span class="old-val">${d365 || "-"}</span>  <span class="new-val">${
              replacementIsNone ? "‡πÑ‡∏°‡πà‡∏°‡∏µ" :
              replacementRow ? String(replacementRow.File5digit || replacementRow["D365 Code"] || "-") :
              (persistedNewD365 || "-")
            }</span></div>
          </div>
          <div class="area-set-row">
            <div class="area-set-key">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï</div>
            <div class="area-set-val"><span class="old-val">${lotVal || "-"}</span>  <span class="new-val">${
              replacementIsNone ? "‡πÑ‡∏°‡πà‡∏°‡∏µ" :
              replacementRow ? String(replacementRow.Lot || replacementRow["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] || "-") :
              (persistedNewLot || "-")
            }</span></div>
          </div>
          <div class="area-set-row">
            <div class="area-set-key">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
            <div class="area-set-val"><span class="old-val">${qtyVal || "-"}</span>  <span class="new-val">${
              replacementIsNone ? "‡πÑ‡∏°‡πà‡∏°‡∏µ" :
              replacementRow ? String(replacementRow["Sum of Qty"] || replacementRow.SumOfQty || replacementRow["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || "-") :
              ((persistedNewProduct === "‡πÑ‡∏°‡πà‡∏°‡∏µ" && persistedNewLot === "‡πÑ‡∏°‡πà‡∏°‡∏µ") ? "‡πÑ‡∏°‡πà‡∏°‡∏µ" : (persistedNewQty || "-"))
            }</span></div>
          </div>
          <div class="area-set-row">
            <div class="area-set-key">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</div>
            <div class="area-set-val"><span class="old-val">${uomVal || "-"}</span>  <span class="new-val">${
              replacementIsNone ? "‡πÑ‡∏°‡πà‡∏°‡∏µ" :
              replacementRow ? String(replacementRow.Name || replacementRow["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"] || "-") :
              (persistedNewUom || "-")
            }</span></div>
          </div>
        `
      : `
          <div class="area-set-row"><div class="area-set-key">Product</div><div class="area-set-val">${product || "-"}</div></div>
          <div class="area-set-row"><div class="area-set-key">D365 Code</div><div class="area-set-val">${d365 || "-"}</div></div>
          <div class="area-set-row"><div class="area-set-key">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï</div><div class="area-set-val">${lotVal || "-"}</div></div>
          <div class="area-set-row"><div class="area-set-key">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div><div class="area-set-val">${qtyVal || "-"}</div></div>
          <div class="area-set-row"><div class="area-set-key">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</div><div class="area-set-val">${uomVal || "-"}</div></div>
        `;

    return `
      <div class="area-set-card"
           data-file5="${d365}"
           data-lot="${lotVal}"
           data-rack="${rackVal}">
        <div class="area-set-content">
          ${replacementHtml}
        </div>
        <div class="area-set-actions">
          ${state === "PENDING"
            ? `
                <button class="btn-yes" onclick="selectDecision(this, 'YES')">Yes</button>
                <button class="btn-no" onclick="selectDecision(this, 'NO')">No</button>
              `
            : `
                <div class="${state === "YES" ? "decision-yes" : "decision-no"}">${state === "YES" ? "‚úÖ" : "‚ùå"}</div>
                <button class="btn-edit-decision" onclick="editDecision(this)">Edit</button>
              `
          }
        </div>
      </div>
    `;
  }).join("");

  updateConfirmBar();
}

async function selectDecision(btn, decision) {
  const card = btn.closest(".area-set-card");
  const file5 = card.dataset.file5 || "";
  const lotVal = card.dataset.lot || "";
  const rackVal = card.dataset.rack || "";
  const rowKey = makeRowKey(file5, lotVal, rackVal);
  if (decision === "NO") {
    const options = allSheetItems
      .filter(r => {
        if (String(r.ID).trim() !== "1") return false;
        return true;
      })
      .map(r => {
        const key = makeRowKey(r.File5digit, r.Lot, r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "");
        return { key, row: r };
      })
      .filter(x => x.key !== rowKey);

    if (options.length === 0) {
      Swal.fire("‚ö†Ô∏è", "‡πÑ‡∏°‡πà‡∏û‡∏ö Product ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô Google Sheet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡∏ô", "warning");
      return;
    }

    const candidates = options.map(o => ({
      key: o.key,
      product: cleanProductText(o.row.Customer || o.row.Product || ""),
      lot: String(o.row.Lot || o.row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] || "").trim()
    }));

    const productList = [
      "‡πÑ‡∏°‡πà‡∏°‡∏µ",
      ...[...new Set(candidates.map(c => c.product).filter(Boolean))]
        .sort((a, b) => a.localeCompare(b))
    ];

    const selected = await Swal.fire({
      title: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product ‡πÉ‡∏´‡∏°‡πà",
      html: `
        <div style="text-align:left;">
          <label for="swalProduct" style="display:block; font-weight:700; margin:0 0 4px 0;">Product</label>
          <select id="swalProduct" class="swal2-select" style="margin:0 0 10px 0; width:100%;">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>
            ${productList.map(p => `<option value="${p}">${p}</option>`).join("")}
          </select>
          <label for="swalLot" style="display:block; font-weight:700; margin:0 0 4px 0;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï</label>
          <select id="swalLot" class="swal2-select" style="margin:0; width:100%;">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>
          </select>
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
      cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
      didOpen: () => {
        const productEl = document.getElementById("swalProduct");
        const lotEl = document.getElementById("swalLot");
        const fillLots = () => {
          const p = productEl.value;
          if (p === "‡πÑ‡∏°‡πà‡∏°‡∏µ") {
            lotEl.innerHTML = `<option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>`;
            lotEl.value = "‡πÑ‡∏°‡πà‡∏°‡∏µ";
            return;
          }
          const lots = [...new Set(candidates.filter(c => c.product === p).map(c => c.lot).filter(Boolean))]
            .sort((a, b) => a.localeCompare(b));
          lotEl.innerHTML =
            `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>` +
            lots.map(l => `<option value="${l}">${l}</option>`).join("");
          if (lots.length === 1) {
            lotEl.value = lots[0];
          }
        };
        productEl.addEventListener("change", fillLots);
      },
      preConfirm: () => {
        const productEl = document.getElementById("swalProduct");
        const lotEl = document.getElementById("swalLot");
        const p = productEl.value;
        const l = lotEl.value;
        if (!p || !l) {
          Swal.showValidationMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product ‡πÅ‡∏•‡∏∞ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï");
          return false;
        }
        if (p === "‡πÑ‡∏°‡πà‡∏°‡∏µ" && l === "‡πÑ‡∏°‡πà‡∏°‡∏µ") {
          return "__NONE__";
        }
        const matched = candidates.find(c => c.product === p && c.lot === l);
        if (!matched) {
          Swal.showValidationMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
          return false;
        }
        return matched.key;
      }
    });

    if (!selected.isConfirmed || !selected.value) return;

    pendingDecisions[rowKey] = {
      decision: "NO",
      replacementKey: selected.value
    };
  } else {
    pendingDecisions[rowKey] = { decision: "YES" };
  }

  const selectedArea = areaSelect.value;
  refreshStatusOptionIcons();
  filterItemsByStorageArea();
  areaSelect.value = selectedArea;
}

function editDecision(btn) {
  const card = btn.closest(".area-set-card");
  const file5 = card.dataset.file5 || "";
  const lotVal = card.dataset.lot || "";
  const rackVal = card.dataset.rack || "";
  const rowKey = makeRowKey(file5, lotVal, rackVal);
  pendingDecisions[rowKey] = { decision: "EDIT" };

  const selectedArea = areaSelect.value;
  refreshStatusOptionIcons();
  filterItemsByStorageArea();
  areaSelect.value = selectedArea;
}

async function confirmSubmitDecisions() {
  const entries = Object.entries(pendingDecisions).filter(([, v]) => {
    if (typeof v === "string") return v === "YES" || v === "NO";
    return v && (v.decision === "YES" || v.decision === "NO");
  });
  if (entries.length === 0) {
    return Swal.fire("‚ÑπÔ∏è", "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Yes/No", "info");
  }

  const selectedZone = customerSelect.value;
  const selectedArea = areaSelect.value;
  const name = selectedWorker.trim();

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    for (const [rowKey, entry] of entries) {
      const decision = typeof entry === "string" ? entry : entry.decision;
      const replacementKey = (typeof entry === "object" && entry) ? (entry.replacementKey || "") : "";
      const [file5, lotVal, rackKey] = rowKey.split("||");
      const baseRow = currentItems.find(r =>
        String(r.ID).trim() === "1" &&
        String(r.File5digit).trim() === file5 &&
        String(r.Lot).trim() === lotVal &&
        normalizeStorageCode(String(r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim()) === rackKey
      );
      if (!baseRow) continue;

      const sumQty = Number(baseRow["Sum of Qty"] || baseRow.SumOfQty || 0);
      const product = String(baseRow.Customer || baseRow.Product || "").trim();
      const d365Base = String(baseRow.File5digit || baseRow["D365 Code"] || "").trim();
      const uomBase = String(baseRow.Name || baseRow["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"] || "").trim();
      const originalRack = String(baseRow.Rack || baseRow["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim();

      let checkedProduct = product;
      let checkedD365Code = d365Base;
      let checkedLotNo = lotVal;
      let checkedQty = String(sumQty);
      let checkedUom = uomBase;
      if (decision === "NO") {
        if (replacementKey === "__NONE__") {
          checkedProduct = "‡πÑ‡∏°‡πà‡∏°‡∏µ";
          checkedD365Code = "‡πÑ‡∏°‡πà‡∏°‡∏µ";
          checkedLotNo = "‡πÑ‡∏°‡πà‡∏°‡∏µ";
          checkedQty = "‡πÑ‡∏°‡πà‡∏°‡∏µ";
          checkedUom = "‡πÑ‡∏°‡πà‡∏°‡∏µ";
        } else if (replacementKey) {
          const replacementRow = findBaseRowByKey(replacementKey);
          if (!replacementRow) {
            throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö Product ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
          }
          checkedProduct = cleanProductText(replacementRow.Customer || replacementRow.Product || "");
          checkedD365Code = String(replacementRow.File5digit || replacementRow["D365 Code"] || "").trim();
          checkedLotNo = String(replacementRow.Lot || replacementRow["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] || "").trim();
          checkedQty = String(replacementRow["Sum of Qty"] || replacementRow.SumOfQty || replacementRow["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || "");
          checkedUom = String(replacementRow.Name || replacementRow["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"] || "").trim();
        }
      }

      const res = await fetch(`${scriptURL}?page=updateRecord`, {
        method: "POST",
        body: new URLSearchParams({
          name,
          recorder: name,
          file5digit: file5,
          lot: lotVal,
          originalRack,
          customer: product,
          sumQty: String(sumQty),
          actRack: checkedProduct,
          actD365Code: checkedD365Code,
          actLot: checkedLotNo,
          actQty: checkedQty,
          actUom: checkedUom,
          actPackage: decision,
          rackId: "1"
        })
      });
      const json = await res.json();
      if (!json.success) {
        throw new Error(json.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }

      currentItems.forEach(r => {
        const sameGroup =
          String(r.File5digit).trim() === file5 &&
          String(r.Lot).trim() === lotVal &&
          normalizeStorageCode(String(r.Rack || r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "").replace(/\[.*?\]/g, "").trim()) === normalizeStorageCode(originalRack);
        if (sameGroup && String(r.ID).trim() === "1") {
          r.Act_Rack = checkedProduct;
          r["D365 Code‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] = checkedD365Code;
          r.Act_D365Code = checkedD365Code;
          r.Act_Lot = checkedLotNo;
          r.Act_Qty = checkedQty;
          r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á"] = checkedUom;
          r.Act_Uom = checkedUom;
          r.Act_Package = decision;
        }
      });
    }

    pendingDecisions = {};
    Swal.close();
    await Swal.fire("‚úÖ", "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
    await fetchItems(selectedWorker);
    customerSelect.value = selectedZone;
    filterItemsByZone();
    refreshStatusOptionIcons();
    areaSelect.value = selectedArea;
    filterItemsByStorageArea();
  } catch (err) {
    Swal.close();
    Swal.fire("‚ùå", err.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  }
}

</script>
</body>
</html>

