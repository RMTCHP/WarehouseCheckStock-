<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì¶ FG Inventory data check</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { overflow-x: hidden; background-color: #f8fafc; }
    .navbar { background: #1e293b; color: white; }
    .navbar-time { font-size: 16px; color: #e2e8f0; font-weight: 500; }

    .sidebar {
      width: 260px; height: 100vh;
      position: fixed; left: 0; top: 56px;
      background: #1e293b; color: white; padding: 15px;
      overflow-y: auto;
    }

    .content { margin-left: 260px; padding: 80px 30px; transition: all 0.3s ease; }
    .progress { height: 22px; margin-top: 10px; display: none; }
    table { font-size: 14px; }

    /* üé® Tabs */
    .nav-tabs { border-bottom: 1px solid #475569; margin-bottom: 15px; }
    .nav-tabs .nav-link {
      color: #cbd5e1; border: none; border-radius: 0; background: transparent;
    }
    .nav-tabs .nav-link.active {
      background-color: #0f7250;
      color: #ffffff;
      font-weight: 600;
    }
    .nav-tabs .nav-link:hover {
      background-color: #1a8a62;
      color: #fff;
    }

    .collapse-content {
      background-color: #0f7250;
      border-radius: 8px; padding: 10px; margin-bottom: 10px;
    }

    /* ‡∏Å‡∏•‡∏∏‡πà‡∏° */
    .table-group {
      background-color: #dbeafe !important;
      color: #1e3a8a; font-weight: 600; border-top: 2px solid #93c5fd;
    }

    .table-detail:hover { background-color: #f1f5f9; }

    /* ‚úÖ Delta */
    .delta-positive {
      color: #15803d !important; background-color: #dcfce7 !important; font-weight: 600;
    }
    .delta-negative {
      color: #b91c1c !important; background-color: #fee2e2 !important; font-weight: 600;
    }
    .delta-zero {
      color: #334155 !important; background-color: #f1f5f9 !important; font-weight: 500;
    }
.arrow {
  color: #6b7280; 
  font-weight: bold;
  padding-right: 6px;
  display: inline-block;   /* <-- ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö */
  width: 12px;             /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ô‡∏¥‡πà‡∏á */
}
/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á popup ‡πÄ‡∏õ‡πá‡∏ô 700px */
.swal-wide {
  width: 700px !important;
  max-width: 90% !important;
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á popup ‡πÄ‡∏õ‡πá‡∏ô auto + scroll ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏¢‡∏≠‡∏∞ */
.swal2-html-container {
  text-align: left !important;
  max-height: 60vh;
  overflow-y: auto;
}
    /* üåü Summary Dashboard Cards */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.summary-card {
  padding: 18px;
  border-radius: 12px;
  background: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  cursor: pointer;
  border-left: 6px solid transparent;   /* default = transparent */
}

/* üé® Color Themes */
.card-blue {
  background: linear-gradient(145deg, #e3f2fd, #bbdefb);
  border-left-color: #2196f3 !important;
}
.card-gray {
  background: linear-gradient(145deg, #f0f0f0, #dcdcdc);
  border-left-color: #757575 !important;
}
.card-green {
  background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
  border-left-color: #43a047 !important;
}
.card-red {
  background: linear-gradient(145deg, #ffebee, #ffcdd2);
  border-left-color: #e53935 !important;
}
.card-orange {
  background: linear-gradient(145deg, #fff3e0, #ffe0b2);
  border-left-color: #fb8c00 !important;
}

.summary-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

.summary-card.active {
  box-shadow: 0 0 0 2px #3b82f6 inset;
}
.summary-title {
  font-size: 15px;
  font-weight: 600;
  color: #475569;
}

.summary-value {
  font-size: 26px;
  font-weight: bold;
  margin-top: 5px;
}
  /* ‚úÖ Navbar right section: button + datetime */
  .navbar-right{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .btn-mainmenu{
    font-weight:600;
    border-color: rgba(226,232,240,.25);
  }
  .btn-mainmenu:hover{
    border-color: rgba(226,232,240,.45);
  }
  /* ===== Final UI Theme (clean) ===== */
  body {
    background: radial-gradient(circle at 14% 8%, #f3f7fb 0%, #edf2f7 52%, #e8eef4 100%);
    color: #102030;
  }

  .navbar {
    min-height: 64px;
    background: linear-gradient(135deg, #073978, #052d61) !important;
    color: #ffffff !important;
    box-shadow: 0 10px 24px rgba(7, 27, 55, 0.28);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .navbar-brand {
    font-weight: 700 !important;
    letter-spacing: 0.01em;
  }

  .navbar-time {
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .btn-mainmenu {
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.12);
  }

  .sidebar {
    width: 280px;
    top: 64px;
    height: calc(100vh - 64px);
    padding: 16px;
    background: linear-gradient(135deg, #0a66d1, #084da0) !important;
    color: #ffffff !important;
    box-shadow: 10px 0 24px rgba(9, 46, 95, 0.24);
    font-size: 13px;
  }

  .content {
    margin-left: 280px;
    padding: 88px 36px 26px;
  }

  .content h4 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #0d223b;
    margin-bottom: 14px;
  }

  .nav-tabs {
    border-bottom: 0;
    gap: 8px;
    margin-bottom: 14px;
  }

  .sidebar .nav-tabs .nav-link {
    border-radius: 10px;
    color: #eaf2ff;
    font-weight: 600;
    border: 1px solid transparent;
    font-size: 12px;
  }

  .sidebar .nav-tabs .nav-link.active {
    background: #083f86 !important;
    color: #ffffff !important;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25), 0 6px 12px rgba(0,0,0,0.16);
  }

  .sidebar .nav-tabs .nav-link:hover {
    background: #0a66d1 !important;
    color: #ffffff !important;
  }

  .sidebar .collapse-content {
    border-radius: 14px;
    background: #083f86 !important;
    border: 1px solid rgba(255,255,255,0.18) !important;
    padding: 14px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.07);
  }

  .sidebar label {
    font-size: 12px;
    font-weight: 600;
    color: #eef4ff;
    margin-bottom: 6px;
  }

  .sidebar .form-control {
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.28);
    box-shadow: none;
    font-size: 12px;
  }

  .sidebar .form-control:focus {
    border-color: #9ec5ff;
    box-shadow: 0 0 0 0.18rem rgba(158, 197, 255, 0.24);
  }

  .sidebar .btn {
    border-radius: 10px;
    font-weight: 600;
    font-size: 12px;
    padding-top: 8px;
    padding-bottom: 8px;
    transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
  }

  .sidebar .btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(7, 30, 62, 0.24);
    filter: brightness(1.04);
  }

  .sidebar button[onclick="exportExcel()"] {
    background: linear-gradient(135deg, #f59e0b, #d97706) !important;
    color: #ffffff !important;
    border: none !important;
  }

  .sidebar button[onclick="exportExcel()"]:hover:not(:disabled) {
    background: linear-gradient(135deg, #fbbf24, #ea8a00) !important;
  }

  .table-responsive {
    background: #ffffff;
    border: 1px solid #dbe5ef;
    border-radius: 14px;
    box-shadow: 0 8px 18px rgba(18, 33, 48, 0.08);
    padding: 8px;
  }

  table {
    font-size: 12px;
  }

  .table-dark {
    --bs-table-bg: #084da0;
    --bs-table-striped-bg: #083f86;
    --bs-table-striped-color: #ffffff;
    --bs-table-color: #ffffff;
  }

  .table thead th {
    border-right: 1px solid rgba(255, 255, 255, 0.25) !important;
    text-align: center;
    vertical-align: middle;
  }

  .table thead th:last-child {
    border-right: none !important;
  }

  .table tbody tr:hover {
    background-color: #f1f6ff;
  }

  #searchTable button.btn-outline-primary[onclick^="openEditSumQty"] {
    font-size: 11px;
    padding: 2px 8px;
    line-height: 1.2;
    border-radius: 8px;
  }

  .summary-grid {
    gap: 12px;
  }

  .summary-card {
    border-radius: 14px;
    box-shadow: 0 8px 18px rgba(16, 32, 48, 0.1);
  }

  .summary-card.active {
    box-shadow: 0 0 0 2px #1a5fb8 inset, 0 8px 18px rgba(16, 32, 48, 0.12);
  }

  .summary-title {
    color: #3f5468;
    font-size: 12px;
    font-weight: 700;
  }

  .summary-value {
    font-size: 20px;
    font-weight: 700;
  }
</style>
</head>
<body>
<nav class="navbar navbar-dark fixed-top px-3 d-flex justify-content-between align-items-center">
  <span class="navbar-brand h4 mb-0">üì¶ FG Inventory data check</span>

  <div class="navbar-right">
    <div class="navbar-time" id="currentDateTime">--/--/---- --:--:--</div>
        <a href="https://rmtchp.github.io/WarehouseCheckStock-/"
       class="btn btn-sm btn-outline-light btn-mainmenu"
       title="Go to Main Menu">
      üè†
    </a>
  </div>
</nav>

  <!-- üß≠ Sidebar with Tabs -->
  <div class="sidebar">
    <ul class="nav nav-tabs nav-justified" id="sidebarTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#searchTab" type="button" role="tab">üîç Search</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadTab" type="button" role="tab">üì§ Upload</button>
      </li>
    </ul>

    <div class="tab-content" id="sidebarTabContent">
      <!-- üîç Search Tab -->
      <div class="tab-pane fade show active" id="searchTab" role="tabpanel">
        <div class="collapse-content">
<label>Start Date</label>
<input type="date" id="startDate" class="form-control mb-2">

<label>End Date</label>
<input type="date" id="endDate" class="form-control mb-3">

<label>Customer</label>
<input type="text" id="searchCustomer" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô KKFT">

<label>File5digit</label>
<input type="text" id="searchFile5" class="form-control mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô F0576">

<label>Lot</label>
<input type="text" id="searchLot" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô 23100280">


          <button class="btn btn-primary w-100 mb-2" onclick="searchData()">Search</button>
          <button class="btn btn-secondary w-100 mb-2" onclick="clearFilters()">Clear Filter</button>
          <button class="btn btn-outline-success w-100" onclick="exportExcel()">Export Excel</button>
        </div>
      </div>

      <!-- üì§ Upload Tab -->
      <div class="tab-pane fade" id="uploadTab" role="tabpanel">
        <div class="collapse-content">
          <input type="file" id="fileInput" class="form-control mb-3" accept=".xlsx,.csv">
          <button id="uploadBtn" class="btn btn-success w-100 mb-2" 
        onclick="uploadToSheet()" disabled style="opacity:0.5; cursor:not-allowed;">
  Upload to Database
</button>

          <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width:0%">0%</div>
          </div>
<button class="btn btn-danger w-100 mt-3" onclick="showDeletePage()">
Delete Data</button>


        </div>
      </div>
    </div>
  </div>

<!-- ===================== CONTENT: SEARCH ===================== -->
<div id="contentSearch" class="content">
  <h4>üîç Search Result</h4>
<div id="summaryBox" style="display:none;">
  <div class="summary-grid">

<!-- Total -->
<div class="summary-card card-blue" id="cardTotal"
     onclick="filterByCard('ALL', this)">
  <div class="summary-title">üîµ Total Records</div>
  <div class="summary-value" id="sumTotal">0</div>
</div>

<!-- Check OK = GRAY -->
<div class="summary-card card-gray" id="cardOK"
     onclick="filterByCard('OK', this)">
  <div class="summary-title">‚ö™ Check OK</div>
  <div class="summary-value" id="sumOK">0</div>
</div>

<!-- Over = GREEN -->
<div class="summary-card card-green" id="cardOver"
     onclick="filterByCard('OVER', this)">
  <div class="summary-title">üü¢ Over (‚ñ≤)</div>
  <div class="summary-value" id="sumOver">0</div>
</div>

<!-- Under = RED -->
<div class="summary-card card-red" id="cardUnder"
     onclick="filterByCard('UNDER', this)">
  <div class="summary-title">üî¥ Under (‚ñº)</div>
  <div class="summary-value" id="sumUnder">0</div>
</div>

<!-- Not Checked = ORANGE -->
<div class="summary-card card-orange" id="cardNotCheck"
     onclick="filterByCard('NOTCHECK', this)">
  <div class="summary-title">üü† Not Checked</div>
  <div class="summary-value" id="sumNotCheck">0</div>
</div>


  </div>
</div>

  <div class="table-responsive mt-3">
    <table class="table table-striped" id="searchTable">
      <thead class="table-dark"><tr id="searchTableHead"></tr></thead>
      <tbody id="searchTableBody"></tbody>
    </table>
  </div>
</div>   <!-- ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ -->

<!-- ===================== CONTENT: UPLOAD ===================== -->
<div id="contentUpload" class="content" style="display:none;">
  <h4>üì§ Upload Result</h4>

  <div id="uploadResultText" class="mt-3 text-secondary">
    ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel‚Ä¶
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-striped" id="uploadTable">
      <thead class="table-dark"><tr id="uploadTableHead"></tr></thead>
      <tbody id="uploadTableBody"></tbody>
    </table>
  </div>
</div> <!-- ‚úÖ ‡∏õ‡∏¥‡∏î contentUpload ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->

<!-- ===================== CONTENT: DELETE ===================== -->
<div id="contentDelete" class="content" style="display:none;">
  <h4>üóë Delete Data</h4>
  <!-- üîç Search Filter -->
<div class="row mb-3">
  <div class="col-md-4">
    <input type="text" id="delSearchCustomer" class="form-control"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Customer‚Ä¶" oninput="filterDeleteTable()">
  </div>
  <div class="col-md-4">
    <input type="text" id="delSearchFile" class="form-control"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ File‚Ä¶" oninput="filterDeleteTable()">
  </div>
  <div class="col-md-4">
    <input type="text" id="delSearchLot" class="form-control"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Lot‚Ä¶" oninput="filterDeleteTable()">
  </div>
</div>

  <div class="mb-2 text-end">
    <button class="btn btn-danger btn-sm" onclick="confirmDeleteAll()">Delete All</button>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-striped" id="deleteTable">
<thead class="table-dark">
  <tr>
    <th>Customer</th>
    <th>File</th>
    <th>Lot</th>
    <th>Rack</th>
    <th>Delete</th>
  </tr>
</thead>
      <tbody id="deleteTableBody"></tbody>
    </table>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbyEwqrF0QNHDpk47695B6s36DyHrTxAuFvSdafgf9wKU33o_KfE8c2m8Y1NomEVQ44u/exec";
  let allData = [];
  let deleteData = [];
  let summaryGroups = {};  // key = File|Lot|RackNorm ‚Üí { totalDelta, checked }

  // üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
  function convertToBangkokTime(utcString) {
    if (!utcString) return "";
    const date = new Date(utcString);
    return date.toLocaleString("th-TH", {
      timeZone: "Asia/Bangkok",
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit",
      hour12: false
    }).replace(",", "");
  }

  // üïì ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ Navbar
  function updateDateTime() {
    const now = new Date();
    const formatted = now.toLocaleString('th-TH', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    document.getElementById('currentDateTime').textContent = formatted;
  }
  setInterval(updateDateTime, 1000); updateDateTime();

function extractRack(rack) {
  if (!rack) return "";
  const match = String(rack).match(/\[(.*?)\]/);
  let clean = match ? match[1] : rack;
  return clean.trim().replace(/\s+/g, "").toUpperCase();
}
    
async function showDeletePage() {

    // üü¢ ‡πÅ‡∏™‡∏î‡∏á popup ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Search)
  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  
  document.getElementById("contentSearch").style.display = "none";
  document.getElementById("contentUpload").style.display = "none";
  document.getElementById("contentDelete").style.display = "block";

  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=ALL`);
    const rows = await res.json();
// ‡∏õ‡∏¥‡∏î popup loading
Swal.close();
    
    const body = document.getElementById("deleteTableBody");
    body.innerHTML = "";

    // üü¢ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ID = 1
    const filtered = rows.filter(r => String(r.ID).trim() === "1");

    if (filtered.length === 0) {
      body.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
        </tr>
      `;
      return;
    }

deleteData = rows.filter(r => String(r.ID).trim() === "1");
renderDeleteTable(deleteData);



  } catch (err) {
    Swal.fire("‚ùå Error", "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  }
}

    
// üì§ Upload Excel
async function uploadToSheet() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return Swal.fire("‚ö†Ô∏è", "Please select a file!", "warning");

  const progress = document.querySelector(".progress");
  const bar = document.getElementById("progressBar");
  progress.style.display = "block";
  bar.style.width = "0%"; 
  bar.innerText = "0%";

  Swal.fire({ title: "Uploading...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  const reader = new FileReader();
  reader.onload = async e => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    const rawRows = XLSX.utils.sheet_to_json(sheet, {
      header: 1,
      blankrows: true,
      defval: ""
    });


// -----------------------------------------------------
// üìå 1)‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 6 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
// -----------------------------------------------------

for (let i = 0; i < rawRows.length; i++) {
  let row = rawRows[i];

  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á = 6 ‡πÄ‡∏™‡∏°‡∏≠ (‡∏à‡∏∞ normalize ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
  if (row.length !== 6) {
    return Swal.fire({
      icon: "error",
      title: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
      html: `
        ‚ùå ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà <b>${i + 1}</b> ‡∏°‡∏µ <b>${row.length}</b> ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå<br>
        ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ <b>6 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</b> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      `
    });
  }

  // üîç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isEmptyRow = row.every(col => String(col).trim() === "");

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß ‚Üí ‡∏Ç‡πâ‡∏≤‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Error
  if (isEmptyRow) {
    continue;
  }

  // ‚ùå ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡πÅ‡∏à‡πâ‡∏á Error
  for (let c = 0; c < 6; c++) {
    if (String(row[c]).trim() === "") {
      return Swal.fire({
        icon: "warning",
        title: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô",
        html: `
          ‚ùå ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà <b>${i + 1}</b> ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà <b>${c + 1}</b> ‡∏ß‡πà‡∏≤‡∏á<br>
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á <b>6 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</b>
        `
      });
    }
  }
}


    // -----------------------------------------------------
    // üìå 2) ‡∏ï‡∏£‡∏ß‡∏à Header ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° Template
    // -----------------------------------------------------
    const expectedHeader = [
      "Customer", "Name", "File5digit", "Lot", "Rack", "SumOfQty"
    ];

    const header = rawRows[0];

    const isHeaderMismatch = header.some((val, i) => {
      if (!val) return true;
      return val.trim() !== expectedHeader[i];
    });

    if (isHeaderMismatch) {
      return Swal.fire({
        icon: "warning",
        title: "Header ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Template",
        html: `
          ‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Header ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô:<br>
          <b>${expectedHeader.join(" | ")}</b><br><br>
          ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á merge ‡∏´‡∏£‡∏∑‡∏≠ format ‡∏û‡∏¥‡πÄ‡∏®‡∏©
        `
      });
    }

    // -----------------------------------------------------
    // üìå 3) Normalize ‚Üí ‡∏•‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 6 ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
    // -----------------------------------------------------
    const fixedRows = rawRows
      .map(r => {
        if (r.length > 6) r = r.slice(0, 6); 
        while (r.length < 6) r.push("");
        return r;
      })
      .filter(r => r.some(col => col !== ""));

    // -----------------------------------------------------
    // üìå 4) ‡∏™‡∏£‡πâ‡∏≤‡∏á Payload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Script
    // -----------------------------------------------------
const payload = fixedRows.slice(1).map(r => ({
  Customer: String(r[0]).trim(),
  Name: String(r[1]).trim(),
  File5digit: String(r[2]).trim(),
  Lot: String(r[3]).trim(),
  Rack: extractRack(r[4]),  // ‚¨ÖÔ∏è ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
  SumOfQty: String(r[5]).trim()
}));


    console.log("UPLOAD PAYLOAD:", payload);

    try {
const res = await fetch(scriptURL, {
  method: "POST",
  headers: {
    "Content-Type": "application/x-www-form-urlencoded"
  },
  body: new URLSearchParams({
    page: "uploadData",
    data: JSON.stringify(payload)
  })
});

      const json = await res.json();

if (!json.success) {
  Swal.fire({
    icon: "error",
    title: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
    html: json.message.replace(/\n/g, "<br>"),
    customClass: "swal-wide"
  });

  progress.style.display = "none";
  bar.style.width = "0%";
  bar.innerText = "0%";
  return;
}

// ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î Swal ‡πÅ‡∏™‡∏î‡∏á progress ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
bar.style.width = "100%";
bar.innerText = "100%";
bar.classList.remove("bg-info");
bar.classList.add("bg-success");

Swal.fire("‚úÖ", json.message, "success").then(() => {

  // üü¢ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå
  document.getElementById("fileInput").value = "";

// ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° upload
uploadBtn.disabled = true;
uploadBtn.style.opacity = "0.5";
uploadBtn.style.cursor = "not-allowed";

  // üü¢ ‡∏ã‡πà‡∏≠‡∏ô progress bar
  progress.style.display = "none";

  // üü¢ Reset progress bar
  bar.style.width = "0%";
  bar.innerText = "0%";

  // üü¢ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏µ progress bar ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
  bar.classList.remove("bg-success");
  bar.classList.add("bg-info");
});


    } catch (err) {
      Swal.fire("‚ùå", "Error uploading data", "error");
    }
  };

  reader.readAsArrayBuffer(file);
}



async function confirmDeleteAll() {

  const confirm = await Swal.fire({
    title: "‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?",
    text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });

  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(`${scriptURL}?page=deleteAll`, { method: "POST" });
    const json = await res.json();

    Swal.close();

    if (!json.success) {
      Swal.fire("‚ùå Error", json.message, "error");
      return;
    }

    Swal.fire("‚úîÔ∏è ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success").then(() => {
      showDeletePage();   // ‚Üê ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ popup)
    });

  } catch (err) {
    Swal.fire("‚ùå Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏ö", "error");
  }
}

  async function searchData() {

  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const customer = document.getElementById("searchCustomer").value.trim().toLowerCase();
  const file5 = document.getElementById("searchFile5").value.trim().toLowerCase();
  const lot = document.getElementById("searchLot").value.trim().toLowerCase();

  Swal.fire({ title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=ALL`);
    const data = await res.json();
    Swal.close();

    const parseDate = ts => {
      if (!ts) return "";
      const [d, m, y] = ts.split(" ")[0].split("/");
      return `${y}-${m}-${d}`;
    };

    const filtered = data.filter(row => {
      const ts = row.Timestamp || "";
      const date = parseDate(ts);

      const customerMatch =
        !customer || (row.Customer || "").toLowerCase().includes(customer);

      const file5Match =
        !file5 || (row.File5digit || "").toLowerCase().includes(file5);

      const lotMatch =
        !lot || (row.Lot || "").toLowerCase().includes(lot);

      const dateMatch =
        (!start || date >= start) && (!end || date <= end);

      return dateMatch && customerMatch && file5Match && lotMatch;
    });

    allData = filtered;

    renderGroupedTable(filtered);
    updateSummary(filtered);

  } catch (err) {
    console.error(err);
    Swal.fire("‚ùå", "Error fetching data", "error");
  }
}


  // üßπ Clear Filter
  function clearFilters() {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("searchFile5").value = "";
    document.getElementById("searchLot").value = "";
    document.getElementById("searchCustomer").value = "";
    Swal.fire("üßπ", "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
  }

function normalizeRack(rack) {
  if (!rack) return "";

  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å [ ... ]
  const match = rack.match(/\[(.*?)\]/);
  let clean = match ? match[1].trim() : rack.trim();

  // üî• ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ Rack ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
  clean = clean.replace(/\s+/g, "").toUpperCase();

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: PC CHP Area = PCCHPAREA
  if (clean === "PCCHPAREA" || clean === "PCCHPAREA".replace(/\s/g, "")) {
    return "PCCHPAREA"; 
  }

  return clean;
}


// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô UI
function displayRack(rack) {
  if (!rack) return "";

  const match = rack.match(/\[(.*?)\]/);
  let clean = match ? match[1].trim() : rack.trim();

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
  let normalized = clean.replace(/\s+/g, "").toUpperCase();

  if (normalized === "PCCHPAREA") return "PCCHPAREA";

  return clean;
}


    function toNum(v) {
  if (v === undefined || v === null) return 0;
  return Number(String(v).replace(/,/g, "")) || 0;
}

    
async function deleteGroup(rowKey) {
  const confirm = await Swal.fire({
    title: "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?",
    text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ File + Lot + Rack ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡∏•‡∏ö",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });

  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(`${scriptURL}?page=adminDeleteGroup`, {
      method: "POST",
      body: new URLSearchParams({ rowKey })
    });

    const json = await res.json();

    if (json.success) {
      Swal.fire("‚úîÔ∏è ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", json.message, "success").then(() => {
        showDeletePage();    // ‚Üê Refresh ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
      });
    } else {
      Swal.fire("‚ùå", json.message, "error");
    }

  } catch (err) {
    Swal.fire("‚ùå Error", "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  }
}


    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô UI
function renderGroupedTable(data) {
const head = document.getElementById("searchTableHead");
const body = document.getElementById("searchTableBody");


  body.innerHTML = "";

  if (!data || data.length === 0) {
    head.innerHTML = "";
    body.innerHTML = "<tr><td colspan='20' class='text-center text-muted'>No data found</td></tr>";
    return;
  }

  const headersRaw = Object.keys(data[0]);
  const headers = headersRaw.filter(h => h !== "ID");

  // ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Edit column
if (!headers.includes("Edit")) {
  headers.push("Edit");
}


  if (!headers.includes("Delta +/-")) {
    const insertIndex = headers.indexOf("Act_Package") + 1;
    headers.splice(insertIndex, 0, "Delta +/-");
  }

  // Render header
  head.innerHTML = headers.map(h => `<th>${h}</th>`).join("");

  // ‚ö° HTML Buffer
  let html = "";

  // ‚ö° GROUP 1: File + Lot
  const mainGroups = {};
  for (const row of data) {
    const key = row.File5digit + "_" + row.Lot;
    (mainGroups[key] ||= []).push(row);
  }

  for (const key in mainGroups) {
    const groupRows = mainGroups[key];
    const [file, lot] = key.split("_");

    const allEmptyGroup = groupRows.every(r =>
      (!r.Act_Rack && !r.Act_Lot && !r.Act_Qty && !r.Act_Package)
    );

    const groupStatusText = allEmptyGroup
      ? " - <span style='color:#b45309;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check</span>"
      : "";

    html += `
      <tr class="table-group">
        <td colspan="${headers.length}">
          üì¶ <b>${file}</b> / <b>${lot}</b> ${groupStatusText}
        </td>
      </tr>
    `;

    // ‚ö° GROUP 2: Rack
    const rackGroups = {};
    for (const r of groupRows) {
      const norm = normalizeRack(r.Rack);
      (rackGroups[norm] ||= []).push(r);
    }

    for (const rackNorm in rackGroups) {
      const rows = rackGroups[rackNorm]
        .slice()
        .sort((a, b) => Number(a.ID) - Number(b.ID));

      html += `
        <tr class="rack-header" style="background:#e2e8f0;">
          <td colspan="${headers.length}" style="font-weight:bold;">
            <span class="arrow">‚ñº</span> Rack: <b>${displayRack(rackNorm)}</b>
          </td>
        </tr>
      `;

      // üöÄ FAST: Prepare values first
      const baseSumQty = toNum(rows[0]["Sum of Qty"] || rows[0].SumOfQty || 0);

      let totalActQty = 0;

for (let i = 0; i < rows.length; i++) {
  const row = rows[i];

  let deltaText = "";
  let deltaClass = "";

  // ‚ùó ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check
  const isNotChecked =
    (!row.Act_Rack && !row.Act_Lot && !row.Act_Qty && !row.Act_Package);

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check ‚Üí ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î Delta, ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏£‡∏ß‡∏°, ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î totalActQty
  if (!isNotChecked) {  
    const actQty = toNum(row.Act_Qty);
    totalActQty += actQty;

    let delta = 0;
    if (i === 0) delta = actQty - baseSumQty;
    else delta = actQty;

    if (delta > 0) {
      deltaText = `‚ñ≤ +${delta}`;
      deltaClass = "delta-positive";
    } else if (delta < 0) {
      deltaText = `‚ñº ${delta}`;
      deltaClass = "delta-negative";
    } else {
      deltaText = "0";
      deltaClass = "delta-zero";
    }
  }

  const hideCols = [
    "Customer", "Name", "File5digit", "Lot", "Rack",
    "SumOfQty", "Sum of Qty"
  ];

  html += `<tr class="rack-row">`;

  for (const h of headers) {
    if (i !== 0 && hideCols.includes(h)) {
      html += "<td></td>";
      continue;
    }

if (h === "Delta +/-") {
  html += `<td class="${deltaClass}">${deltaText}</td>`;

} else if (h === "Timestamp") {
  html += `<td>${convertToBangkokTime(row[h])}</td>`;

} else if (h === "Rack") {
  html += `<td>${displayRack(row[h])}</td>`;

} else if (h === "Act_Rack") {
  html += `<td>${displayRack(row[h])}</td>`;

} else if (h === "Edit") {
  if (String(row.ID).trim() === "1") {
    html += `
      <td>
        <button class="btn btn-sm btn-outline-primary"
          onclick='openEditSumQty(${JSON.stringify(row)})'>
          ‚úèÔ∏è Edit
        </button>
      </td>
    `;
  } else {
    html += "<td></td>";
  }

} else {
  html += `<td>${row[h] ?? ""}</td>`;
}

  }

  html += `</tr>`;
}


      // ‚ö° ‡∏£‡∏ß‡∏° Rack ‡∏ô‡∏µ‡πâ
      const allEmpty = rows.every(r =>
        (!r.Act_Rack && !r.Act_Lot && !r.Act_Qty && !r.Act_Package)
      );

      if (!allEmpty) {
        const rackTotal = totalActQty - baseSumQty;
        let className = rackTotal > 0
          ? "delta-positive"
          : rackTotal < 0
          ? "delta-negative"
          : "delta-zero";

        html += `
          <tr class="rack-row" style="background:#f8fafc; font-weight:bold;">
            <td colspan="${headers.length - 1}" class="text-end">‡∏£‡∏ß‡∏° Rack ‡∏ô‡∏µ‡πâ:</td>
            <td class="${className}">
              ${rackTotal > 0 ? "‚ñ≤ +" + rackTotal :
                rackTotal < 0 ? "‚ñº " + rackTotal : "0"}
            </td>
          </tr>
        `;
      }
    }
  }

  // ‚ö° Render HTML ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  body.innerHTML = html;
}
function renderDeleteTable(list) {
  const body = document.getElementById("deleteTableBody");
  body.innerHTML = "";

  if (!list || list.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
      </tr>
    `;
    return;
  }

  list.forEach(r => {
    const rackNorm = extractRack(r.Rack);
    const rowKey = `${r.File5digit}|${r.Lot}|${rackNorm}`;

    body.innerHTML += `
      <tr>
        <td>${r.Customer}</td>
        <td>${r.File5digit}</td>
        <td>${r.Lot}</td>
        <td>${rackNorm}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteGroup('${rowKey}')">
            ‡∏•‡∏ö
          </button>
        </td>
      </tr>
    `;
  });
}

    function filterDeleteTable() {
  const c = document.getElementById("delSearchCustomer").value.trim().toLowerCase();
  const f = document.getElementById("delSearchFile").value.trim().toLowerCase();
  const l = document.getElementById("delSearchLot").value.trim().toLowerCase();

  const filtered = deleteData.filter(r => {
    const cMatch = !c || (r.Customer || "").toLowerCase().includes(c);
    const fMatch = !f || (r.File5digit || "").toLowerCase().includes(f);
    const lMatch = !l || (r.Lot || "").toLowerCase().includes(l);
    return cMatch && fMatch && lMatch;
  });

  renderDeleteTable(filtered);
}


// üì§ Export Excel ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö UI
// üì§ Export Excel ‡πÅ‡∏ö‡∏ö UI + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏µ DeltaValue (Conditional Formatting)
async function exportExcel() {
  if (!allData || allData.length === 0) {
    Swal.fire("‚ÑπÔ∏è", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å", "info");
    return;
  }

  const toNum = v => Number(String(v ?? 0).replace(/,/g, "")) || 0;

  const sortedData = [...allData].sort((a, b) => {
    const f1 = String(a.File5digit).localeCompare(String(b.File5digit));
    if (f1 !== 0) return f1;
    const l1 = String(a.Lot).localeCompare(String(b.Lot));
    if (l1 !== 0) return l1;
    return Number(a.ID) - Number(b.ID);
  });

  const exportData = [];

  // Group data
  const mainGroups = {};
  sortedData.forEach(r => {
    const key = `${r.File5digit}_${r.Lot}`;
    if (!mainGroups[key]) mainGroups[key] = [];
    mainGroups[key].push(r);
  });

  for (const key in mainGroups) {
    const groupRows = mainGroups[key];

    const rackGroups = {};
    groupRows.forEach(r => {
      const rackNorm = normalizeRack(r.Rack);
      if (!rackGroups[rackNorm]) rackGroups[rackNorm] = [];
      rackGroups[rackNorm].push(r);
    });

    for (const rackNorm in rackGroups) {
      const rows = rackGroups[rackNorm].sort((a, b) => Number(a.ID) - Number(b.ID));

      const baseSumQty = toNum(rows[0]["Sum of Qty"] || rows[0].SumOfQty);

      
      rows.forEach(row => {
        const actQty = toNum(row.Act_Qty);

// ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏Ñ
// ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏Ñ
const notChecked =
  (!row.Act_Rack && !row.Act_Lot && !row.Act_Qty && !row.Act_Package);

let delta = "";
if (!notChecked) {
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß
  if (row.ID == rows[0].ID) {
    delta = actQty - baseSumQty;
  } else {
    delta = actQty;
  }
}

const isMainRow = (row.ID == rows[0].ID);

exportData.push({
Customer: row.Customer || "",
Name: row.Name || "",
File5digit: row.File5digit || "",
Lot: row.Lot || "",
Rack: displayRack(rackNorm) || "",

// ‚≠ê Sum of Qty ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ID = 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
"Sum of Qty": isMainRow ? baseSumQty : "",


  Act_Rack: displayRack(row.Act_Rack) || "",
  Act_Lot: row.Act_Lot || "",
  Act_Qty: row.Act_Qty || "",
  Act_Package: row.Act_Package || "",

  // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check ‚Üí ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
  DeltaValue: delta === "" ? "" : delta,

  "Delta +/-":
    delta === "" ? "" :
    (delta > 0 ? `‚ñ≤ +${delta}` : delta < 0 ? `‚ñº ${delta}` : "0"),

  Timestamp: row.Timestamp ? convertToBangkokTime(row.Timestamp) : ""
});

      });
    }
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook + Sheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(exportData, { origin: "A1" });

  // Auto width
  ws["!cols"] = Object.keys(exportData[0]).map(key => ({
    wch: Math.max(
      key.length,
      ...exportData.map(r => (r[key] ? r[key].toString().length : 0))
    ) + 2
  }));

  // ‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Conditional Formatting ‡πÉ‡∏ô Excel ‚≠ê‚≠ê
  const deltaColIndex = Object.keys(exportData[0]).indexOf("DeltaValue");
  const deltaColLetter = XLSX.utils.encode_col(deltaColIndex); // ‡πÄ‡∏ä‡πà‡∏ô "L"
  const startRow = 2;
  const endRow = exportData.length + 1;

ws['!condfmt'] = [
  {
    ref: `${deltaColLetter}${startRow}:${deltaColLetter}${endRow}`,
    rules: [
      // > 0 ‚Üí Green fill
      {
        type: "cellIs",
        operator: "greaterThan",
        formula: ["0"],
        style: {
          fill: { patternType: "solid", fgColor: { rgb: "C6EFCE" } }, // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
          font: { color: { rgb: "006100" }, bold: true }
        }
      },

      // < 0 ‚Üí Red fill
      {
        type: "cellIs",
        operator: "lessThan",
        formula: ["0"],
        style: {
          fill: { patternType: "solid", fgColor: { rgb: "FFC7CE" } }, // ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô
          font: { color: { rgb: "9C0006" }, bold: true }
        }
      }
    ]
  }
];


  XLSX.utils.book_append_sheet(wb, ws, "WarehouseData");

  // File name
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  const hh = String(now.getHours()).padStart(2, "0");
  const min = String(now.getMinutes()).padStart(2, "0");
  const ss = String(now.getSeconds()).padStart(2, "0");

  const fileName = `FGInventoryDataCheck_${yyyy}-${mm}-${dd}_${hh}${min}${ss}.xlsx`;

  XLSX.writeFile(wb, fileName);
  Swal.fire("‚úÖ", "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
}

    
// ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Delete ‡∏ï‡∏≠‡∏ô‡∏™‡∏•‡∏±‡∏ö tab
document.getElementById("search-tab").addEventListener("click", () => {
  document.getElementById("contentSearch").style.display = "block";
  document.getElementById("contentUpload").style.display = "none";
  document.getElementById("contentDelete").style.display = "none";
});

document.getElementById("upload-tab").addEventListener("click", () => {
  document.getElementById("contentSearch").style.display = "none";
  document.getElementById("contentUpload").style.display = "block";
  document.getElementById("contentDelete").style.display = "none";
});

    
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");

fileInput.addEventListener("change", () => {
  if (fileInput.files.length === 0) {
    uploadBtn.disabled = true;
    uploadBtn.style.opacity = "0.5";
    uploadBtn.style.cursor = "not-allowed";
    return;
  }

  const name = fileInput.files[0].name.toLowerCase();
  if (!name.endsWith(".xlsx") && !name.endsWith(".xls")) {
    Swal.fire("‚ö†Ô∏è", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx / .xls)", "warning");
    fileInput.value = "";
    uploadBtn.disabled = true;
    uploadBtn.style.opacity = "0.5";
    uploadBtn.style.cursor = "not-allowed";
    return;
  }

  uploadBtn.disabled = false;
  uploadBtn.style.opacity = "1";
  uploadBtn.style.cursor = "pointer";
});

function updateSummary(data) {
  if (!data || data.length === 0) {
    document.getElementById("summaryBox").style.display = "none";
    summaryGroups = {};
    return;
  }

  // reset ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà search ‡πÉ‡∏´‡∏°‡πà
  summaryGroups = {};
  document.querySelectorAll(".summary-card").forEach(c => c.classList.remove("active"));

  const id1Rows = data.filter(r => String(r.ID).trim() === "1");

  let groups = [];

  for (const r of id1Rows) {
    const rackNorm = normalizeRack(r.Rack);
    const key = `${r.File5digit}|${r.Lot}|${rackNorm}`;

    const childRows = data.filter(row =>
      row.File5digit === r.File5digit &&
      row.Lot === r.Lot &&
      normalizeRack(row.Rack) === rackNorm
    );

    const baseSumQty = Number(r.SumOfQty || r["Sum of Qty"] || 0);

    let totalAct = 0;
    let hasCheck = false;

    childRows.forEach(c => {
      const act = Number(c.Act_Qty || 0);
      if (act) hasCheck = true;
      totalAct += act;
    });

    const totalDelta = totalAct - baseSumQty;

    const g = { key, totalDelta, checked: hasCheck };
    groups.push(g);
    summaryGroups[key] = g;  // ‚Üê ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ filterByCard
  }

  const total = groups.length;
  const ok = groups.filter(g => g.checked && g.totalDelta === 0).length;
  const over = groups.filter(g => g.checked && g.totalDelta > 0).length;
  const under = groups.filter(g => g.checked && g.totalDelta < 0).length;
  const notChecked = groups.filter(g => !g.checked).length;

  document.getElementById("sumTotal").textContent = total;
  document.getElementById("sumOK").textContent = ok;
  document.getElementById("sumOver").textContent = over;
  document.getElementById("sumUnder").textContent = under;
  document.getElementById("sumNotCheck").textContent = notChecked;

  document.getElementById("summaryBox").style.display = "block";
}
    
function openEditSumQty(row) {

  const currentQty = row.SumOfQty || row["Sum of Qty"] || 0;

  Swal.fire({
    title: "‚úèÔ∏è Edit Sum of Qty",
    customClass: "swal-wide",
    html: `
      <div class="text-start">
        <label class="form-label">Customer</label>
        <input class="form-control mb-2" value="${row.Customer}" disabled>

        <label class="form-label">File5digit</label>
        <input class="form-control mb-2" value="${row.File5digit}" disabled>

        <label class="form-label">Lot</label>
        <input class="form-control mb-2" value="${row.Lot}" disabled>

        <label class="form-label">Rack</label>
        <input class="form-control mb-2" value="${row.Rack}" disabled>

        <label class="form-label fw-bold text-primary">
          Sum of Qty (Editable)
        </label>
        <input id="editSumQty"
          type="number"
          class="form-control"
          value="${currentQty}">
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: "üíæ Save",
    cancelButtonText: "Cancel",
    preConfirm: () => {
      const v = document.getElementById("editSumQty").value;
      if (v === "" || isNaN(v)) {
        Swal.showValidationMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Sum of Qty");
        return false;
      }
      return v;
    }
  }).then(async (res) => {
    if (!res.isConfirmed) return;

    Swal.fire({
      title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    try {
      const params = new URLSearchParams({
        page: "adminUpdateSumQty",
        customer: row.Customer,
        file5digit: row.File5digit,
        lot: row.Lot,
        rack: row.Rack,
        sumQty: res.value
      });

      const resp = await fetch(scriptURL, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: params
      });

      const json = await resp.json();
      Swal.close();

      if (!json.success) {
        Swal.fire("‚ùå Error", json.message, "error");
        return;
      }

      Swal.fire("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Sum of Qty ‡πÅ‡∏•‡πâ‡∏ß", "success");
      searchData(); // refresh ‡∏ï‡∏≤‡∏£‡∏≤‡∏á

    } catch (err) {
      Swal.fire("‚ùå Error", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
    }
  });
}

    
function filterByCard(type, el) {
  if (!allData || allData.length === 0) return;

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå active ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß set active ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏î
  document.querySelectorAll(".summary-card").forEach(c => c.classList.remove("active"));
  if (el) el.classList.add("active");

  // ‡∏Å‡∏£‡∏ì‡∏µ Total Records ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏• search ‡∏õ‡∏Å‡∏ï‡∏¥
  if (type === "ALL") {
    renderGroupedTable(allData);
    return;
  }

  const filtered = allData.filter(row => {
    const rackNorm = normalizeRack(row.Rack);
    const key = `${row.File5digit}|${row.Lot}|${rackNorm}`;
    const g = summaryGroups[key];
    if (!g) return false;

    if (type === "OK")      return g.checked && g.totalDelta === 0;
    if (type === "OVER")    return g.checked && g.totalDelta > 0;
    if (type === "UNDER")   return g.checked && g.totalDelta < 0;
    if (type === "NOTCHECK")return !g.checked;

    return true;
  });

  renderGroupedTable(filtered);
}

  </script>
</body>
</html>
