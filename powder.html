<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß™ Powder Inventory data check</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { overflow-x: hidden; background-color: #f8fafc; }
    .navbar { background: #1e293b; color: white; }
    .navbar-time { font-size: 16px; color: #e2e8f0; font-weight: 500; }

    .sidebar {
      width: 260px; height: 100vh;
      position: fixed; left: 0; top: 56px;
      background: #1e293b; color: white; padding: 15px;
      overflow-y: auto;
    }

    .content { margin-left: 260px; padding: 80px 30px; transition: all 0.3s ease; }
    .progress { height: 22px; margin-top: 10px; display: none; }
    table { font-size: 14px; }

    /* üé® Tabs */
    .nav-tabs { border-bottom: 1px solid #475569; margin-bottom: 15px; }
    .nav-tabs .nav-link {
      color: #cbd5e1; border: none; border-radius: 0; background: transparent;
    }
    .nav-tabs .nav-link.active {
      background-color: #0f7250;
      color: #ffffff;
      font-weight: 600;
    }
    .nav-tabs .nav-link:hover {
      background-color: #1a8a62;
      color: #fff;
    }

    .collapse-content {
      background-color: #0f7250;
      border-radius: 8px; padding: 10px; margin-bottom: 10px;
    }

    /* ‡∏Å‡∏•‡∏∏‡πà‡∏° */
    .table-group {
      background-color: #dbeafe !important;
      color: #1e3a8a; font-weight: 600; border-top: 2px solid #93c5fd;
    }

    .table-detail:hover { background-color: #f1f5f9; }

    /* ‚úÖ Delta */
    .delta-positive {
      color: #15803d !important; background-color: #dcfce7 !important; font-weight: 600;
    }
    .delta-negative {
      color: #b91c1c !important; background-color: #fee2e2 !important; font-weight: 600;
    }
    .delta-zero {
      color: #334155 !important; background-color: #f1f5f9 !important; font-weight: 500;
    }
.arrow {
  color: #6b7280; 
  font-weight: bold;
  padding-right: 6px;
  display: inline-block;   /* <-- ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö */
  width: 12px;             /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ô‡∏¥‡πà‡∏á */
}
/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á popup ‡πÄ‡∏õ‡πá‡∏ô 700px */
.swal-wide {
  width: 700px !important;
  max-width: 90% !important;
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á popup ‡πÄ‡∏õ‡πá‡∏ô auto + scroll ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏¢‡∏≠‡∏∞ */
.swal2-html-container {
  text-align: left !important;
  max-height: 60vh;
  overflow-y: auto;
}
    /* üåü Summary Dashboard Cards */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.summary-card {
  padding: 18px;
  border-radius: 12px;
  background: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  cursor: pointer;
  border-left: 6px solid transparent;   /* default = transparent */
}

/* üé® Color Themes */
.card-blue {
  background: linear-gradient(145deg, #e3f2fd, #bbdefb);
  border-left-color: #2196f3 !important;
}
.card-gray {
  background: linear-gradient(145deg, #f0f0f0, #dcdcdc);
  border-left-color: #757575 !important;
}
.card-green {
  background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
  border-left-color: #43a047 !important;
}
.card-red {
  background: linear-gradient(145deg, #ffebee, #ffcdd2);
  border-left-color: #e53935 !important;
}
.card-orange {
  background: linear-gradient(145deg, #fff3e0, #ffe0b2);
  border-left-color: #fb8c00 !important;
}

.summary-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

.summary-card.active {
  box-shadow: 0 0 0 2px #3b82f6 inset;
}
.summary-title {
  font-size: 15px;
  font-weight: 600;
  color: #475569;
}

.summary-value {
  font-size: 26px;
  font-weight: bold;
  margin-top: 5px;
}
  /* ‚úÖ Navbar right section: button + datetime */
  .navbar-right{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .btn-mainmenu{
    font-weight:600;
    border-color: rgba(226,232,240,.25);
  }
  .btn-mainmenu:hover{
    border-color: rgba(226,232,240,.45);
  }
  /* ===== Final UI Theme (clean) ===== */
  body {
    background: radial-gradient(circle at 14% 8%, #f3f7fb 0%, #edf2f7 52%, #e8eef4 100%);
    color: #102030;
  }

  .navbar {
    min-height: 64px;
    background: linear-gradient(135deg, #0c5f43, #084a35) !important;
    color: #ffffff !important;
    box-shadow: 0 10px 24px rgba(8, 52, 36, 0.28);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .navbar-brand {
    font-weight: 700 !important;
    letter-spacing: 0.01em;
  }

  .navbar-time {
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .btn-mainmenu {
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.12);
  }

  .sidebar {
    width: 280px;
    top: 64px;
    height: calc(100vh - 64px);
    padding: 16px;
    background: linear-gradient(135deg, #129266, #0f7250) !important;
    color: #ffffff !important;
    box-shadow: 10px 0 24px rgba(9, 50, 36, 0.24);
    font-size: 13px;
  }

  .content {
    margin-left: 280px;
    padding: 88px 36px 26px;
  }

  .content h4 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #0d2a1f;
    margin-bottom: 14px;
  }

  .nav-tabs {
    border-bottom: 0;
    gap: 8px;
    margin-bottom: 14px;
  }

  .sidebar .nav-tabs .nav-link {
    border-radius: 10px;
    color: #e8fff5;
    font-weight: 600;
    border: 1px solid transparent;
    font-size: 12px;
  }

  .sidebar .nav-tabs .nav-link.active {
    background: #0c5f43 !important;
    color: #ffffff !important;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25), 0 6px 12px rgba(0,0,0,0.16);
  }

  .sidebar .nav-tabs .nav-link:hover {
    background: #129266 !important;
    color: #ffffff !important;
  }

  .sidebar .collapse-content {
    border-radius: 14px;
    background: #0c5f43 !important;
    border: 1px solid rgba(255,255,255,0.18) !important;
    padding: 14px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.07);
  }

  .sidebar label {
    font-size: 12px;
    font-weight: 600;
    color: #ebfff6;
    margin-bottom: 6px;
  }

  .sidebar .form-control {
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.28);
    box-shadow: none;
    font-size: 12px;
  }

  .sidebar .form-control:focus {
    border-color: #90ffd2;
    box-shadow: 0 0 0 0.18rem rgba(144, 255, 210, 0.24);
  }

  .sidebar .btn {
    border-radius: 10px;
    font-weight: 600;
    font-size: 12px;
    padding-top: 8px;
    padding-bottom: 8px;
    transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
  }

  .sidebar .btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(8, 32, 23, 0.24);
    filter: brightness(1.04);
  }

  .sidebar button[onclick="exportExcel()"] {
    background: linear-gradient(135deg, #f59e0b, #d97706) !important;
    color: #ffffff !important;
    border: none !important;
  }

  .sidebar button[onclick="exportExcel()"]:hover:not(:disabled) {
    background: linear-gradient(135deg, #fbbf24, #ea8a00) !important;
  }

  .table-responsive {
    background: #ffffff;
    border: 1px solid #dbe5ef;
    border-radius: 14px;
    box-shadow: 0 8px 18px rgba(18, 33, 48, 0.08);
    padding: 8px;
  }

  table {
    font-size: 12px;
  }

  .table-dark {
    --bs-table-bg: #0f7250;
    --bs-table-striped-bg: #0c5f43;
    --bs-table-striped-color: #ffffff;
    --bs-table-color: #ffffff;
  }

  .table thead th {
    border-right: 1px solid rgba(255, 255, 255, 0.25) !important;
    text-align: center;
    vertical-align: middle;
  }

  .table thead th:last-child {
    border-right: none !important;
  }

  .table tbody tr:hover {
    background-color: #f1fbf6;
  }

  #searchTable button.btn-outline-primary[onclick^="openEditSumQty"] {
    font-size: 11px;
    padding: 2px 8px;
    line-height: 1.2;
    border-radius: 8px;
    color: #0c5f43 !important;
    border-color: #0c5f43 !important;
  }

  #searchTable button.btn-outline-primary[onclick^="openEditSumQty"]:hover {
    background: #0c5f43 !important;
    border-color: #0c5f43 !important;
    color: #ffffff !important;
  }

  .summary-grid {
    gap: 12px;
  }

  .summary-card {
    border-radius: 14px;
    box-shadow: 0 8px 18px rgba(16, 32, 48, 0.1);
  }

  .summary-card.active {
    box-shadow: 0 0 0 2px #167c5a inset, 0 8px 18px rgba(16, 32, 48, 0.12);
  }

  .summary-title {
    color: #3f5468;
    font-size: 12px;
    font-weight: 700;
  }

  .summary-value {
    font-size: 20px;
    font-weight: 700;
  }
</style>
</head>
<body>
<nav class="navbar navbar-dark fixed-top px-3 d-flex justify-content-between align-items-center">
  <span class="navbar-brand h4 mb-0">üß™ Powder Inventory data check</span>

  <div class="navbar-right">
    <div class="navbar-time" id="currentDateTime">--/--/---- --:--:--</div>
        <a href="https://rmtchp.github.io/WarehouseCheckStock-/"
       class="btn btn-sm btn-outline-light btn-mainmenu"
       title="Go to Main Menu">
      üè†
    </a>
  </div>
</nav>

  <!-- üß≠ Sidebar with Tabs -->
  <div class="sidebar">
    <ul class="nav nav-tabs nav-justified" id="sidebarTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#searchTab" type="button" role="tab">üîç Search</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadTab" type="button" role="tab">üì§ Upload</button>
      </li>
    </ul>

    <div class="tab-content" id="sidebarTabContent">
      <!-- üîç Search Tab -->
      <div class="tab-pane fade show active" id="searchTab" role="tabpanel">
        <div class="collapse-content">
<label>Start Date</label>
<input type="date" id="startDate" class="form-control mb-2">

<label>End Date</label>
<input type="date" id="endDate" class="form-control mb-3">

<label>Product</label>
<input type="text" id="searchCustomer" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô PT-3448">

<label>D365 Code</label>
<input type="text" id="searchFile5" class="form-control mb-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô R-00-006-B">

<label>Lot</label>
<input type="text" id="searchLot" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô 23100280">


          <button class="btn btn-primary w-100 mb-2" onclick="searchData()">Search</button>
          <button class="btn btn-secondary w-100 mb-2" onclick="clearFilters()">Clear Filter</button>
          <button class="btn btn-outline-success w-100" onclick="exportExcel()">Export Excel</button>
        </div>
      </div>

      <!-- üì§ Upload Tab -->
      <div class="tab-pane fade" id="uploadTab" role="tabpanel">
        <div class="collapse-content">
          <input type="file" id="fileInput" class="form-control mb-3" accept=".xlsx,.csv">
          <button id="uploadBtn" class="btn btn-success w-100 mb-2" 
        onclick="uploadToSheet()" disabled style="opacity:0.5; cursor:not-allowed;">
  Upload to Database
</button>

          <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width:0%">0%</div>
          </div>
<button class="btn btn-danger w-100 mt-3" onclick="showDeletePage()">
Delete Data</button>


        </div>
      </div>
    </div>
  </div>

<!-- ===================== CONTENT: SEARCH ===================== -->
<div id="contentSearch" class="content">
  <h4>üîç Search Result</h4>
<div id="summaryBox" style="display:none;">
  <div class="summary-grid">

<!-- Total -->
<div class="summary-card card-blue" id="cardTotal"
     onclick="filterByCard('ALL', this)">
  <div class="summary-title">üîµ Total Records</div>
  <div class="summary-value" id="sumTotal">0</div>
</div>

<!-- Check Yes = GRAY -->
<div class="summary-card card-green" id="cardYes"
     onclick="filterByCard('YES', this)">
  <div class="summary-title">üü¢ Check Yes</div>
  <div class="summary-value" id="sumYes">0</div>
</div>

<!-- Check No = RED -->
<div class="summary-card card-red" id="cardNo"
     onclick="filterByCard('NO', this)">
  <div class="summary-title">üî¥ Check No</div>
  <div class="summary-value" id="sumNo">0</div>
</div>

<!-- Not Checked = ORANGE -->
<div class="summary-card card-orange" id="cardNotCheck"
     onclick="filterByCard('NOTCHECK', this)">
  <div class="summary-title">üü† Not Checked</div>
  <div class="summary-value" id="sumNotCheck">0</div>
</div>


  </div>
</div>

  <div class="table-responsive mt-3">
    <table class="table table-striped" id="searchTable">
      <thead class="table-dark"><tr id="searchTableHead"></tr></thead>
      <tbody id="searchTableBody"></tbody>
    </table>
  </div>
</div>   <!-- ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ -->

<!-- ===================== CONTENT: UPLOAD ===================== -->
<div id="contentUpload" class="content" style="display:none;">
  <h4>üì§ Upload Result</h4>

  <div id="uploadResultText" class="mt-3 text-secondary">
    ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel‚Ä¶
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-striped" id="uploadTable">
      <thead class="table-dark"><tr id="uploadTableHead"></tr></thead>
      <tbody id="uploadTableBody"></tbody>
    </table>
  </div>
</div> <!-- ‚úÖ ‡∏õ‡∏¥‡∏î contentUpload ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->

<!-- ===================== CONTENT: DELETE ===================== -->
<div id="contentDelete" class="content" style="display:none;">
  <h4>üóë Delete Data</h4>
  <!-- üîç Search Filter -->
<div class="row mb-3">
  <div class="col-md-4">
    <input type="text" id="delSearchCustomer" class="form-control"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Product‚Ä¶" oninput="filterDeleteTable()">
  </div>
  <div class="col-md-4">
    <input type="text" id="delSearchFile" class="form-control"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ D365 Code‚Ä¶" oninput="filterDeleteTable()">
  </div>
  <div class="col-md-4">
    <input type="text" id="delSearchLot" class="form-control"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï‚Ä¶" oninput="filterDeleteTable()">
  </div>
</div>

  <div class="mb-2 text-end">
    <button class="btn btn-danger btn-sm" onclick="confirmDeleteAll()">Delete All</button>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-striped" id="deleteTable">
<thead class="table-dark">
  <tr>
    <th>Product</th>
    <th>D365 Code</th>
    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï</th>
    <th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</th>
    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
    <th>‡∏•‡∏ö</th>
  </tr>
</thead>
      <tbody id="deleteTableBody"></tbody>
    </table>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const powderScriptURL = "https://script.google.com/macros/s/AKfycbw7DHUxP6S57hQ5soISQlXRfzQdtUZELXxTpUcQcCtkYRqHOaiFltqE7Flg3X5KDcKq/exec";
  const scriptURL = powderScriptURL !== "PUT_POWDER_SCRIPT_URL_HERE"
    ? powderScriptURL
    : "https://script.google.com/macros/s/AKfycbw7DHUxP6S57hQ5soISQlXRfzQdtUZELXxTpUcQcCtkYRqHOaiFltqE7Flg3X5KDcKq/exec";
  let allData = [];
  let deleteData = [];
  let summaryGroups = {};  // key = File|Lot|RackNorm ‚Üí { totalDelta, checked }

  // üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
  function convertToBangkokTime(utcString) {
    if (!utcString) return "";
    const date = new Date(utcString);
    return date.toLocaleString("th-TH", {
      timeZone: "Asia/Bangkok",
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit",
      hour12: false
    }).replace(",", "");
  }

  // üïì ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ Navbar
  function updateDateTime() {
    const now = new Date();
    const formatted = now.toLocaleString('th-TH', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    document.getElementById('currentDateTime').textContent = formatted;
  }
  setInterval(updateDateTime, 1000); updateDateTime();

function extractRack(rack) {
  if (!rack) return "";
  const raw = String(rack).trim();
  const afterLastBracket = raw.includes("]") ? raw.split("]").pop().trim() : "";
  const outside = raw.replace(/\[[^\]]*\]/g, "").trim();
  const inside = (raw.match(/\[([^\]]*)\]/) || [,""])[1].trim();
  const clean = afterLastBracket || outside || inside || raw;
  return clean.replace(/\s+/g, "").toUpperCase();
}

function cleanProductText(product) {
  return String(product || "")
    .replace(/^\s*(?:\[[^\]]*\]\s*)+/, "")
    .trim();
}
    
async function showDeletePage() {

    // üü¢ ‡πÅ‡∏™‡∏î‡∏á popup ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Search)
  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  
  document.getElementById("contentSearch").style.display = "none";
  document.getElementById("contentUpload").style.display = "none";
  document.getElementById("contentDelete").style.display = "block";

  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=ALL`);
    const rows = await res.json();
// ‡∏õ‡∏¥‡∏î popup loading
Swal.close();
    
    const body = document.getElementById("deleteTableBody");
    body.innerHTML = "";

    // üü¢ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ID = 1
    const filtered = rows.filter(r => String(r.ID).trim() === "1");

    if (filtered.length === 0) {
      body.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
        </tr>
      `;
      return;
    }

deleteData = rows.filter(r => String(r.ID).trim() === "1");
renderDeleteTable(deleteData);



  } catch (err) {
    Swal.fire("‚ùå Error", "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
  }
}

    
// üì§ Upload Excel
async function uploadToSheet() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return Swal.fire("‚ö†Ô∏è", "Please select a file!", "warning");

  const progress = document.querySelector(".progress");
  const bar = document.getElementById("progressBar");
  progress.style.display = "block";
  bar.style.width = "0%"; 
  bar.innerText = "0%";

  Swal.fire({ title: "Uploading...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  const reader = new FileReader();
  reader.onload = async e => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    const rawRows = XLSX.utils.sheet_to_json(sheet, {
      header: 1,
      blankrows: true,
      defval: ""
    });


// -----------------------------------------------------
// üìå 1)‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 6 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
// -----------------------------------------------------

for (let i = 0; i < rawRows.length; i++) {
  let row = rawRows[i];

  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á = 6 ‡πÄ‡∏™‡∏°‡∏≠ (‡∏à‡∏∞ normalize ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
  if (row.length !== 6) {
    return Swal.fire({
      icon: "error",
      title: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
      html: `
        ‚ùå ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà <b>${i + 1}</b> ‡∏°‡∏µ <b>${row.length}</b> ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå<br>
        ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ <b>6 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</b> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      `
    });
  }

  // üîç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isEmptyRow = row.every(col => String(col).trim() === "");

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß ‚Üí ‡∏Ç‡πâ‡∏≤‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Error
  if (isEmptyRow) {
    continue;
  }

  // ‚ùå ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡πÅ‡∏à‡πâ‡∏á Error
  for (let c = 0; c < 6; c++) {
    if (String(row[c]).trim() === "") {
      return Swal.fire({
        icon: "warning",
        title: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô",
        html: `
          ‚ùå ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà <b>${i + 1}</b> ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà <b>${c + 1}</b> ‡∏ß‡πà‡∏≤‡∏á<br>
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á <b>6 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</b>
        `
      });
    }
  }
}


    // -----------------------------------------------------
    // üìå 2) ‡∏ï‡∏£‡∏ß‡∏à Header ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° Template
    // -----------------------------------------------------
    const expectedHeader = [
      "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö", "Product", "D365 Code"
    ];

    const header = rawRows[0];

    const isHeaderMismatch = header.some((val, i) => {
      if (!val) return true;
      return val.trim() !== expectedHeader[i];
    });

    if (isHeaderMismatch) {
      return Swal.fire({
        icon: "warning",
        title: "Header ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Template",
        html: `
          ‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Header ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô:<br>
          <b>${expectedHeader.join(" | ")}</b><br><br>
          ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á merge ‡∏´‡∏£‡∏∑‡∏≠ format ‡∏û‡∏¥‡πÄ‡∏®‡∏©
        `
      });
    }

    // -----------------------------------------------------
    // üìå 3) Normalize ‚Üí ‡∏•‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 6 ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
    // -----------------------------------------------------
    const fixedRows = rawRows
      .map(r => {
        if (r.length > 6) r = r.slice(0, 6); 
        while (r.length < 6) r.push("");
        return r;
      })
      .filter(r => r.some(col => col !== ""));

    // -----------------------------------------------------
    // üìå 4) ‡∏™‡∏£‡πâ‡∏≤‡∏á Payload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Script
    // -----------------------------------------------------
const payload = fixedRows.slice(1).map(r => ({
  // Powder import schema:
  // [0]=‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö, [1]=‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï, [2]=‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, [3]=‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö, [4]=Product, [5]=D365 Code
  "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö": String(r[0]).trim(),
  "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï": String(r[1]).trim(),
  "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": String(r[2]).trim(),
  "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö": String(r[3]).trim(),
  "Product": String(r[4]).trim(),
  "D365 Code": String(r[5]).trim()
}));


    console.log("UPLOAD PAYLOAD:", payload);

    try {
const res = await fetch(scriptURL, {
  method: "POST",
  headers: {
    "Content-Type": "application/x-www-form-urlencoded"
  },
  body: new URLSearchParams({
    page: "uploadData",
    data: JSON.stringify(payload)
  })
});

      const json = await res.json();

if (!json.success) {
  Swal.fire({
    icon: "error",
    title: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
    html: json.message.replace(/\n/g, "<br>"),
    customClass: "swal-wide"
  });

  progress.style.display = "none";
  bar.style.width = "0%";
  bar.innerText = "0%";
  return;
}

// ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î Swal ‡πÅ‡∏™‡∏î‡∏á progress ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
bar.style.width = "100%";
bar.innerText = "100%";
bar.classList.remove("bg-info");
bar.classList.add("bg-success");

Swal.fire("‚úÖ", json.message, "success").then(() => {

  // üü¢ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå
  document.getElementById("fileInput").value = "";

// ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° upload
uploadBtn.disabled = true;
uploadBtn.style.opacity = "0.5";
uploadBtn.style.cursor = "not-allowed";

  // üü¢ ‡∏ã‡πà‡∏≠‡∏ô progress bar
  progress.style.display = "none";

  // üü¢ Reset progress bar
  bar.style.width = "0%";
  bar.innerText = "0%";

  // üü¢ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏µ progress bar ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
  bar.classList.remove("bg-success");
  bar.classList.add("bg-info");
});


    } catch (err) {
      Swal.fire("‚ùå", "Error uploading data", "error");
    }
  };

  reader.readAsArrayBuffer(file);
}



async function confirmDeleteAll() {

  const confirm = await Swal.fire({
    title: "‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?",
    text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  });

  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(`${scriptURL}?page=deleteAll`, { method: "POST" });
    const json = await res.json();

    Swal.close();

    if (!json.success) {
      Swal.fire("‚ùå Error", json.message, "error");
      return;
    }

    Swal.fire("‚úîÔ∏è ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success").then(() => {
      showDeletePage();   // ‚Üê ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ popup)
    });

  } catch (err) {
    Swal.fire("‚ùå Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏ö", "error");
  }
}

  async function searchData() {

  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const customer = document.getElementById("searchCustomer").value.trim().toLowerCase();
  const file5 = document.getElementById("searchFile5").value.trim().toLowerCase();
  const lot = document.getElementById("searchLot").value.trim().toLowerCase();

  Swal.fire({ title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  try {
    const res = await fetch(`${scriptURL}?page=getDataByName&name=ALL`);
    const data = await res.json();
    Swal.close();

    const parseDate = ts => {
      if (!ts) return "";

      if (ts instanceof Date && !isNaN(ts.getTime())) {
        return ts.toISOString().slice(0, 10);
      }

      const s = String(ts).trim();
      if (!s) return "";

      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö dd/MM/yyyy HH:mm:ss
      if (s.includes("/")) {
        const datePart = s.split(" ")[0];
        const parts = datePart.split("/");
        if (parts.length === 3) {
          const [d, m, y] = parts;
          if (y && m && d) return `${y}-${m}-${d}`;
        }
      }

      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ISO/‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà Date parse ‡πÑ‡∏î‡πâ
      const dt = new Date(s);
      if (!isNaN(dt.getTime())) {
        return dt.toISOString().slice(0, 10);
      }

      return "";
    };

    const filtered = data.filter(row => {
      const ts = row.Timestamp || "";
      const date = parseDate(ts);

      const product = (row.Product ?? row.Customer ?? "").toString().toLowerCase();
      const d365Code = (row["D365 Code"] ?? row.File5digit ?? "").toString().toLowerCase();
      const lotNo = (row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? row.Lot ?? "").toString().toLowerCase();

      const customerMatch =
        !customer || product.includes(customer);

      const file5Match =
        !file5 || d365Code.includes(file5);

      const lotMatch =
        !lot || lotNo.includes(lot);

      const dateMatch =
        (!start || date >= start) && (!end || date <= end);

      return dateMatch && customerMatch && file5Match && lotMatch;
    });

    allData = filtered;

    renderGroupedTable(filtered);
    updateSummary(filtered);

  } catch (err) {
    console.error(err);
    Swal.fire("‚ùå", "Error fetching data", "error");
  }
}


  // üßπ Clear Filter
  function clearFilters() {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("searchFile5").value = "";
    document.getElementById("searchLot").value = "";
    document.getElementById("searchCustomer").value = "";
    Swal.fire("üßπ", "‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
  }

function normalizeRack(rack) {
  if (!rack) return "";
  const raw = String(rack).trim();
  const afterLastBracket = raw.includes("]") ? raw.split("]").pop().trim() : "";
  const outside = raw.replace(/\[[^\]]*\]/g, "").trim();
  const inside = (raw.match(/\[([^\]]*)\]/) || [,""])[1].trim();
  let clean = afterLastBracket || outside || inside || raw;

  // üî• ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ Rack ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
  clean = clean.replace(/\s+/g, "").toUpperCase();

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: PC CHP Area = PCCHPAREA
  if (clean === "PCCHPAREA" || clean === "PCCHPAREA".replace(/\s/g, "")) {
    return "PCCHPAREA"; 
  }

  return clean;
}

function getZoneLabel(storageArea) {
  const norm = normalizeRack(storageArea || "");
  if (!norm) return "-";
  if (norm === "RESERVE-AREA" || norm === "RESERVEAREA") return "RESERVE-AREA";

  // Wimol mapping (‡∏ï‡∏≤‡∏°‡∏ú‡∏±‡∏á‡πÇ‡∏ã‡∏ô)
  if (/^(AA|AB|AC)-?\d+/i.test(norm)) return "Zone : RM-RACK (A)";
  if (/^(BA|BB|BC|BD)-?\d+/i.test(norm)) return "Zone : RM-RACK (B)";
  if (/^(CA|CB|CC|CD)-?\d+/i.test(norm)) return "Zone : RM-RACK (C)";
  if (/^(DA|DB|DC)-?\d+/i.test(norm)) return "Zone : RM-RACK (D)";

  // Wichit mapping
  if (/^C\d{1,2}-?\d+/i.test(norm)) return "Zone : RM-Zone (C)";
  if (/^D\d{1,2}-?\d+/i.test(norm)) return "Zone : RM-Zone (D)";
  if (/^E\d{1,2}-?\d+/i.test(norm)) return "Zone : RM-Zone (E)";

  const lead = norm.charAt(0);
  if (["A", "B", "C", "D"].includes(lead)) return `Zone : RM-RACK (${lead})`;
  return "Zone : RM-Zone (E)";
}


// ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö key ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
const headerLabelMap = {
  Customer: "Product",
  Name: "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö",
  File5digit: "D365 Code",
  Lot: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï",
  Rack: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö",
  SumOfQty: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô",
  "Sum of Qty": "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô",
  "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à": "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à",
  Act_Rack: "Product ‡∏à‡∏£‡∏¥‡∏á",
  Act_Lot: "‡∏•‡πá‡∏≠‡∏ï‡∏à‡∏£‡∏¥‡∏á",
  Act_Qty: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á",
  Act_Uom: "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á",
  "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
  Timestamp: "‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï",
  Edit: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
};

function getHeaderLabel(h) {
  return headerLabelMap[h] || h;
}

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô UI
function displayRack(rack) {
  if (!rack) return "";
  const raw = String(rack).trim();
  const afterLastBracket = raw.includes("]") ? raw.split("]").pop().trim() : "";
  const outside = raw.replace(/\[[^\]]*\]/g, "").trim();
  const inside = (raw.match(/\[([^\]]*)\]/) || [,""])[1].trim();
  let clean = afterLastBracket || outside || inside || raw;

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
  let normalized = clean.replace(/\s+/g, "").toUpperCase();

  if (normalized === "PCCHPAREA") return "PCCHPAREA";

  return clean;
}

function toNum(v) {
  if (v === undefined || v === null) return 0;
  return Number(String(v).replace(/,/g, "")) || 0;
}

function renderGroupedTable(data) {
const head = document.getElementById("searchTableHead");
const body = document.getElementById("searchTableBody");


  body.innerHTML = "";

  if (!data || data.length === 0) {
    head.innerHTML = "";
    body.innerHTML = "<tr><td colspan='20' class='text-center text-muted'>No data found</td></tr>";
    return;
  }

  const headers = [
    "Product", "D365 Code", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö",
    "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "Act_Rack", "Act_Lot", "Act_Qty", "Act_Uom", "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "Timestamp", "Edit"
  ];

  // ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Edit column
  // Render header
  head.innerHTML = headers.map(h => `<th>${getHeaderLabel(h)}</th>`).join("");

  // ‚ö° HTML Buffer
  let html = "";

  // ‚ö° GROUP 1: Zone + Rack
  const mainGroups = {};
  for (const row of data) {
    const storageArea = row["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? row.Rack ?? "";
    const zone = getZoneLabel(storageArea);
    const rackNorm = normalizeRack(storageArea);
    const key = zone + "|" + rackNorm;
    (mainGroups[key] ||= []).push(row);
  }

  const zoneOrder = {
    "Zone : RM-RACK (A)": 1,
    "Zone : RM-RACK (B)": 2,
    "Zone : RM-RACK (C)": 3,
    "Zone : RM-RACK (D)": 4,
    "Zone : RM-Zone (C)": 5,
    "Zone : RM-Zone (D)": 6,
    "Zone : RM-Zone (E)": 7,
    "RESERVE-AREA": 99
  };
  const rackCmp = (a, b) => String(a || "").localeCompare(String(b || ""), undefined, { numeric: true, sensitivity: "base" });
  const sortedMainKeys = Object.keys(mainGroups).sort((ka, kb) => {
    const [za, ra] = ka.split("|");
    const [zb, rb] = kb.split("|");
    const zaOrder = zoneOrder[za] ?? 98;
    const zbOrder = zoneOrder[zb] ?? 98;
    if (zaOrder !== zbOrder) return zaOrder - zbOrder;
    return rackCmp(ra, rb);
  });

  for (const key of sortedMainKeys) {
    const groupRows = mainGroups[key];
    const groupZone = getZoneLabel(groupRows[0]?.["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? groupRows[0]?.Rack ?? "");
    const rackNorm = normalizeRack(groupRows[0]?.["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? groupRows[0]?.Rack ?? "");

    const allEmptyGroup = groupRows.every(r =>
      (!r.Act_Rack && !r.Act_Lot && !r.Act_Qty && !r.Act_Package)
    );

    const groupStatusText = allEmptyGroup
      ? " - <span style='color:#b45309;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check</span>"
      : "";

    html += `
      <tr class="table-group">
        <td colspan="${headers.length}">
          üì¶ <b>${groupZone}</b> | Rack: <b>${displayRack(rackNorm)}</b> ${groupStatusText}
        </td>
      </tr>
    `;

    // ‚ö° GROUP 2: D365 Code + ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Rack ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
    const itemGroups = {};
    for (const r of groupRows) {
      const fileCode = (r["D365 Code"] ?? r.File5digit ?? "").toString();
      const lotNo = (r["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? r.Lot ?? "").toString();
      const itemKey = fileCode + "_" + lotNo;
      (itemGroups[itemKey] ||= []).push(r);
    }

    let rackDeltaTotal = 0;
    let hasCheckedInRack = false;

    for (const itemKey in itemGroups) {
      const rows = itemGroups[itemKey]
        .slice()
        .sort((a, b) => Number(a.ID) - Number(b.ID));

      const baseSumQty = toNum(rows[0]["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || rows[0]["Sum of Qty"] || rows[0].SumOfQty || 0);
      let totalActQty = 0;

for (let i = 0; i < rows.length; i++) {
  const row = rows[i];

  let deltaText = "";
  let deltaClass = "";

  // ‚ùó ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check
  const isNotChecked =
    (!row.Act_Rack && !row.Act_Lot && !row.Act_Qty && !row.Act_Package);

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Check ‚Üí ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î Delta, ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏£‡∏ß‡∏°, ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î totalActQty
  if (!isNotChecked) {  
    const actQty = toNum(row.Act_Qty);
    totalActQty += actQty;

    let delta = 0;
    if (i === 0) delta = actQty - baseSumQty;
    else delta = actQty;

    if (delta > 0) {
      deltaText = `‚ñ≤ +${delta}`;
      deltaClass = "delta-positive";
    } else if (delta < 0) {
      deltaText = `‚ñº ${delta}`;
      deltaClass = "delta-negative";
    } else {
      deltaText = "0";
      deltaClass = "delta-zero";
    }
  }

  const hideCols = [
    "Product", "D365 Code", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï", "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö",
    "Customer", "Name", "File5digit", "Lot", "Rack", "SumOfQty", "Sum of Qty"
  ];

  html += `<tr class="rack-row">`;
  const resultUpper = String(row["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"] ?? row.Result ?? row.Act_Package ?? "").trim().toUpperCase();
  const noTextStyle = resultUpper === "NO" ? ' style="color:#b91c1c;"' : "";

  for (const h of headers) {
    if (i !== 0 && hideCols.includes(h)) {
      html += "<td></td>";
      continue;
    }

if (h === "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å") {
  html += `<td>${row["‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"] ?? row.Recorder ?? ""}</td>`;

} else if (h === "Timestamp") {
  html += `<td>${convertToBangkokTime(row[h])}</td>`;

} else if (h === "Rack") {
  html += `<td>${displayRack(row[h])}</td>`;

} else if (h === "Act_Rack") {
  html += `<td${noTextStyle}>${cleanProductText(row["Product‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Rack ?? "")}</td>`;

} else if (h === "Act_Uom") {
  html += `<td${noTextStyle}>${row["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Uom ?? ""}</td>`;

} else if (h === "Product") {
  html += `<td>${cleanProductText(row.Product ?? row.Customer ?? "")}</td>`;

} else if (h === "D365 Code") {
  html += `<td>${row["D365 Code"] ?? row.File5digit ?? ""}</td>`;

} else if (h === "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï") {
  html += `<td>${row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? row.Lot ?? ""}</td>`;

} else if (h === "Act_Lot") {
  html += `<td${noTextStyle}>${row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Lot ?? ""}</td>`;

} else if (h === "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö") {
  html += `<td>${displayRack(row["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? row.Rack ?? "")}</td>`;

} else if (h === "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô") {
  html += `<td>${row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] ?? row["Sum of Qty"] ?? row.SumOfQty ?? ""}</td>`;

} else if (h === "Act_Qty") {
  html += `<td${noTextStyle}>${row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Qty ?? ""}</td>`;

} else if (h === "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö") {
  html += `<td>${row["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"] ?? row.Name ?? ""}</td>`;

} else if (h === "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à") {
  const resultText = String(row["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"] ?? row.Result ?? row.Act_Package ?? "").trim();
  const resultUpper = resultText.toUpperCase();
  if (resultUpper === "YES" || resultUpper === "NO") {
    const resultColor = resultUpper === "NO" ? "color:#b91c1c;" : "";
    html += `<td style="background-color:#fff9c4; font-weight:600; text-align:center; ${resultColor}">${resultText}</td>`;
  } else {
    html += `<td>${resultText}</td>`;
  }

} else if (h === "Edit") {
  if (String(row.ID).trim() === "1") {
    html += `
      <td>
        <button class="btn btn-sm btn-outline-primary"
          onclick='openEditSumQty(${JSON.stringify(row)})'>
          ‚úèÔ∏è Edit
        </button>
      </td>
    `;
  } else {
    html += "<td></td>";
  }

} else {
  html += `<td>${row[h] ?? ""}</td>`;
}

  }

  html += `</tr>`;
}

      const allEmpty = rows.every(r =>
        (!r.Act_Rack && !r.Act_Lot && !r.Act_Qty && !r.Act_Package)
      );
      if (!allEmpty) {
        rackDeltaTotal += (totalActQty - baseSumQty);
        hasCheckedInRack = true;
      }
    }

    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ "‡∏£‡∏ß‡∏° Rack ‡∏ô‡∏µ‡πâ" ‡∏ï‡∏≤‡∏° requirement
  }

  // ‚ö° Render HTML ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  body.innerHTML = html;
}
function renderDeleteTable(list) {
  const body = document.getElementById("deleteTableBody");
  body.innerHTML = "";

  if (!list || list.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
      </tr>
    `;
    return;
  }

  list.forEach(r => {
    const product = cleanProductText(r.Product ?? r.Customer ?? "");
    const d365Code = (r["D365 Code"] ?? r.File5digit ?? "").toString().trim();
    const lot = (r["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? r.Lot ?? "").toString().trim();
    const storageArea = (r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? r.Rack ?? "").toString().trim();
    const qty = (r["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] ?? r["Sum of Qty"] ?? r.SumOfQty ?? "").toString().trim();
    const uom = (r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"] ?? r.Name ?? "").toString().trim();
    const rackNorm = extractRack(storageArea);
    const rowKey = `${d365Code}|${lot}|${rackNorm}`;

    body.innerHTML += `
      <tr>
        <td>${product}</td>
        <td>${d365Code}</td>
        <td>${lot}</td>
        <td>${rackNorm}</td>
        <td>${qty}</td>
        <td>${uom}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteGroup('${rowKey}')">
            ‡∏•‡∏ö
          </button>
        </td>
      </tr>
    `;
  });
}

    function filterDeleteTable() {
  const c = document.getElementById("delSearchCustomer").value.trim().toLowerCase();
  const f = document.getElementById("delSearchFile").value.trim().toLowerCase();
  const l = document.getElementById("delSearchLot").value.trim().toLowerCase();

  const filtered = deleteData.filter(r => {
    const product = (r.Product ?? r.Customer ?? "").toString().toLowerCase();
    const d365Code = (r["D365 Code"] ?? r.File5digit ?? "").toString().toLowerCase();
    const lot = (r["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? r.Lot ?? "").toString().toLowerCase();
    const cMatch = !c || product.includes(c);
    const fMatch = !f || d365Code.includes(f);
    const lMatch = !l || lot.includes(l);
    return cMatch && fMatch && lMatch;
  });

  renderDeleteTable(filtered);
}


// üì§ Export Excel ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Search Result
async function exportExcel() {
  if (!allData || allData.length === 0) {
    Swal.fire("‚ÑπÔ∏è", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å", "info");
    return;
  }

  const sortedData = [...allData].sort((a, b) => {
    const rackA = normalizeRack(a["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? a.Rack ?? "");
    const rackB = normalizeRack(b["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? b.Rack ?? "");
    const zA = getZoneLabel(rackA);
    const zB = getZoneLabel(rackB);
    const zCmp = String(zA).localeCompare(String(zB), undefined, { numeric: true, sensitivity: "base" });
    if (zCmp !== 0) return zCmp;
    const rCmp = String(rackA).localeCompare(String(rackB), undefined, { numeric: true, sensitivity: "base" });
    if (rCmp !== 0) return rCmp;
    const dCmp = String(a["D365 Code"] ?? a.File5digit ?? "").localeCompare(String(b["D365 Code"] ?? b.File5digit ?? ""));
    if (dCmp !== 0) return dCmp;
    const lCmp = String(a["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? a.Lot ?? "").localeCompare(String(b["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? b.Lot ?? ""));
    if (lCmp !== 0) return lCmp;
    return Number(a.ID || 0) - Number(b.ID || 0);
  });

  const exportData = sortedData.map(row => ({
    "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö": displayRack(row["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? row.Rack ?? ""),
    "Product": cleanProductText(row.Product ?? row.Customer ?? ""),
    "D365 Code": row["D365 Code"] ?? row.File5digit ?? "",
    "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï": row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? row.Lot ?? "",
    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] ?? row["Sum of Qty"] ?? row.SumOfQty ?? "",
    "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö": row["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"] ?? row.Name ?? "",
    "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à": row["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"] ?? row.Result ?? row.Act_Package ?? "",
    "Product ‡∏à‡∏£‡∏¥‡∏á": cleanProductText(row["Product‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Rack ?? ""),
    "‡∏•‡πá‡∏≠‡∏ï‡∏à‡∏£‡∏¥‡∏á": row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Lot ?? "",
    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á": row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Qty ?? "",
    "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á": row["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á"] ?? row.Act_Uom ?? "",
    "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": row["‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"] ?? row.Recorder ?? "",
    "‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï": convertToBangkokTime(row.Timestamp)
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(exportData, { origin: "A1" });

  ws["!cols"] = Object.keys(exportData[0]).map(key => ({
    wch: Math.max(
      key.length,
      ...exportData.map(r => (r[key] ? r[key].toString().length : 0))
    ) + 2
  }));

  XLSX.utils.book_append_sheet(wb, ws, "PowderData");

  // File name
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  const hh = String(now.getHours()).padStart(2, "0");
  const min = String(now.getMinutes()).padStart(2, "0");
  const ss = String(now.getSeconds()).padStart(2, "0");

  const fileName = `PowderInventoryDataCheck_${yyyy}-${mm}-${dd}_${hh}${min}${ss}.xlsx`;

  XLSX.writeFile(wb, fileName);
  Swal.fire("‚úÖ", "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
}

    
// ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Delete ‡∏ï‡∏≠‡∏ô‡∏™‡∏•‡∏±‡∏ö tab
function resetSearchView() {
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  document.getElementById("searchFile5").value = "";
  document.getElementById("searchLot").value = "";
  document.getElementById("searchCustomer").value = "";

  allData = [];
  summaryGroups = {};
  document.querySelectorAll(".summary-card").forEach(c => c.classList.remove("active"));
  document.getElementById("summaryBox").style.display = "none";

  document.getElementById("searchTableHead").innerHTML = "";
  document.getElementById("searchTableBody").innerHTML = "";
}

document.getElementById("search-tab").addEventListener("click", () => {
  document.getElementById("contentSearch").style.display = "block";
  document.getElementById("contentUpload").style.display = "none";
  document.getElementById("contentDelete").style.display = "none";
  resetSearchView();
});

document.getElementById("upload-tab").addEventListener("click", () => {
  document.getElementById("contentSearch").style.display = "none";
  document.getElementById("contentUpload").style.display = "block";
  document.getElementById("contentDelete").style.display = "none";
  resetSearchView();
});

    
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");

fileInput.addEventListener("change", () => {
  if (fileInput.files.length === 0) {
    uploadBtn.disabled = true;
    uploadBtn.style.opacity = "0.5";
    uploadBtn.style.cursor = "not-allowed";
    return;
  }

  const name = fileInput.files[0].name.toLowerCase();
  if (!name.endsWith(".xlsx") && !name.endsWith(".xls")) {
    Swal.fire("‚ö†Ô∏è", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx / .xls)", "warning");
    fileInput.value = "";
    uploadBtn.disabled = true;
    uploadBtn.style.opacity = "0.5";
    uploadBtn.style.cursor = "not-allowed";
    return;
  }

  uploadBtn.disabled = false;
  uploadBtn.style.opacity = "1";
  uploadBtn.style.cursor = "pointer";
});

function updateSummary(data) {
  if (!data || data.length === 0) {
    document.getElementById("summaryBox").style.display = "none";
    summaryGroups = {};
    return;
  }

  // reset ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà search ‡πÉ‡∏´‡∏°‡πà
  summaryGroups = {};
  document.querySelectorAll(".summary-card").forEach(c => c.classList.remove("active"));

  const id1Rows = data.filter(r => String(r.ID).trim() === "1");

  const getProductKey = row => {
    const product = String(row.Product ?? row.Customer ?? "").trim();
    const d365 = String(row["D365 Code"] ?? row.File5digit ?? "").trim();
    const lot = String(row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? row.Lot ?? "").trim();
    const rack = normalizeRack(row["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? row.Rack ?? "");
    return `${product}|${d365}|${lot}|${rack}`;
  };

  let groups = [];

  for (const r of id1Rows) {
    const key = getProductKey(r);

    const childRows = data.filter(row =>
      String(row["D365 Code"] ?? row.File5digit ?? "").trim() === String(r["D365 Code"] ?? r.File5digit ?? "").trim() &&
      String(row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? row.Lot ?? "").trim() === String(r["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? r.Lot ?? "").trim() &&
      normalizeRack(row["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? row.Rack ?? "") === normalizeRack(r["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? r.Rack ?? "") &&
      String(row.Product ?? row.Customer ?? "").trim() === String(r.Product ?? r.Customer ?? "").trim()
    );

    const baseSumQty = Number(r["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || r.SumOfQty || r["Sum of Qty"] || 0);

    let totalAct = 0;
    let hasCheck = false;

    childRows.forEach(c => {
      const act = Number(c["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? c.Act_Qty ?? 0);
      const resultRaw = String(c["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"] ?? c.Act_Package ?? "").trim().toUpperCase();
      const hasCheckedByResult = (resultRaw === "YES" || resultRaw === "NO");
      const hasCheckedByFields =
        String(c["Product‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? c.Act_Rack ?? "").trim() !== "" ||
        String(c["D365 Code‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? c.Act_D365Code ?? "").trim() !== "" ||
        String(c["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏¥‡∏á"] ?? c.Act_Lot ?? "").trim() !== "";
      if (hasCheckedByResult || hasCheckedByFields) hasCheck = true;
      totalAct += act;
    });

    const totalDelta = totalAct - baseSumQty;

    // ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏∞‡∏î‡∏±‡∏ö "‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô child row
    const groupResults = childRows
      .map(c => String(c["‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"] ?? c.Act_Package ?? "").trim().toUpperCase())
      .filter(Boolean);
    const result = groupResults.includes("NO")
      ? "NO"
      : groupResults.includes("YES")
      ? "YES"
      : "";
    const g = { key, totalDelta, checked: hasCheck, result };
    groups.push(g);
    summaryGroups[key] = g;  // ‚Üê ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ filterByCard
  }

  const total = groups.length;
  const yes = groups.filter(g => g.checked && g.result === "YES").length;
  const no = groups.filter(g => g.checked && g.result === "NO").length;
  const notChecked = groups.filter(g => !g.checked).length;

  document.getElementById("sumTotal").textContent = total;
  document.getElementById("sumYes").textContent = yes;
  document.getElementById("sumNo").textContent = no;
  document.getElementById("sumNotCheck").textContent = notChecked;

  document.getElementById("summaryBox").style.display = "block";
}
    
function openEditSumQty(row) {

  const currentQty = row.SumOfQty || row["Sum of Qty"] || 0;

  Swal.fire({
    title: "‚úèÔ∏è Edit Sum of Qty",
    customClass: "swal-wide",
    html: `
      <div class="text-start">
        <label class="form-label">Customer</label>
        <input class="form-control mb-2" value="${row.Customer}" disabled>

        <label class="form-label">File5digit</label>
        <input class="form-control mb-2" value="${row.File5digit}" disabled>

        <label class="form-label">Lot</label>
        <input class="form-control mb-2" value="${row.Lot}" disabled>

        <label class="form-label">Rack</label>
        <input class="form-control mb-2" value="${row.Rack}" disabled>

        <label class="form-label fw-bold text-primary">
          Sum of Qty (Editable)
        </label>
        <input id="editSumQty"
          type="number"
          class="form-control"
          value="${currentQty}">
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: "üíæ Save",
    cancelButtonText: "Cancel",
    preConfirm: () => {
      const v = document.getElementById("editSumQty").value;
      if (v === "" || isNaN(v)) {
        Swal.showValidationMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Sum of Qty");
        return false;
      }
      return v;
    }
  }).then(async (res) => {
    if (!res.isConfirmed) return;

    Swal.fire({
      title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    try {
      const params = new URLSearchParams({
        page: "adminUpdateSumQty",
        customer: row.Customer,
        file5digit: row.File5digit,
        lot: row.Lot,
        rack: row.Rack,
        sumQty: res.value
      });

      const resp = await fetch(scriptURL, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: params
      });

      const json = await resp.json();
      Swal.close();

      if (!json.success) {
        Swal.fire("‚ùå Error", json.message, "error");
        return;
      }

      Swal.fire("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Sum of Qty ‡πÅ‡∏•‡πâ‡∏ß", "success");
      searchData(); // refresh ‡∏ï‡∏≤‡∏£‡∏≤‡∏á

    } catch (err) {
      Swal.fire("‚ùå Error", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
    }
  });
}

    
function filterByCard(type, el) {
  if (!allData || allData.length === 0) return;

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå active ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß set active ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏î
  document.querySelectorAll(".summary-card").forEach(c => c.classList.remove("active"));
  if (el) el.classList.add("active");

  // ‡∏Å‡∏£‡∏ì‡∏µ Total Records ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏• search ‡∏õ‡∏Å‡∏ï‡∏¥
  if (type === "ALL") {
    renderGroupedTable(allData);
    return;
  }

  const filtered = allData.filter(row => {
    const product = String(row.Product ?? row.Customer ?? "").trim();
    const d365 = String(row["D365 Code"] ?? row.File5digit ?? "").trim();
    const lot = String(row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πá‡∏≠‡∏ï"] ?? row.Lot ?? "").trim();
    const rackNorm = normalizeRack(row["‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] ?? row.Rack ?? "");
    const key = `${product}|${d365}|${lot}|${rackNorm}`;
    const g = summaryGroups[key];
    if (!g) return false;

    if (type === "YES")     return g.checked && g.result === "YES";
    if (type === "NO")      return g.checked && g.result === "NO";
    if (type === "NOTCHECK")return !g.checked;

    return true;
  });

  renderGroupedTable(filtered);
}

  </script>
</body>
</html>








